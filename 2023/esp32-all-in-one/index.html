<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>ESP 32 —— ALL IN ONE | Triority's blog</title><meta name="author" content="Triority"><meta name="copyright" content="Triority"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="ALL IN ONE！！！">
<meta property="og:type" content="article">
<meta property="og:title" content="ESP 32 —— ALL IN ONE">
<meta property="og:url" content="http://triority.cc/2023/esp32-all-in-one/index.html">
<meta property="og:site_name" content="Triority&#39;s blog">
<meta property="og:description" content="ALL IN ONE！！！">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://triority.cc/img/esp32-pinout-chip-ESP-WROOM-32.webp">
<meta property="article:published_time" content="2023-03-07T10:14:48.000Z">
<meta property="article:modified_time" content="2025-10-16T14:58:40.929Z">
<meta property="article:author" content="Triority">
<meta property="article:tag" content="arduino">
<meta property="article:tag" content="PCB设计">
<meta property="article:tag" content="esp32">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://triority.cc/img/esp32-pinout-chip-ESP-WROOM-32.webp"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://triority.cc/2023/esp32-all-in-one/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":10,"unescape":true,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ESP 32 —— ALL IN ONE',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-10-16 14:58:40'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><style type="text/css">
.spoiler {
  display: inline-flex;
}
p.spoiler {
  display: flex;
}
.spoiler a {
  pointer-events: none;
}
.spoiler-blur, .spoiler-blur > * {
  transition: text-shadow .5s ease;
}
.spoiler .spoiler-blur, .spoiler .spoiler-blur > * {
  color: rgba(0, 0, 0, 0);
  background-color: rgba(0, 0, 0, 0);
  text-shadow: 0 0 10px grey;
  cursor: pointer;
}
.spoiler .spoiler-blur:hover, .spoiler .spoiler-blur:hover > * {
  text-shadow: 0 0 5px grey;
}
.spoiler-box, .spoiler-box > * {
  transition: color .5s ease,
  background-color .5s ease;
}
.spoiler .spoiler-box, .spoiler .spoiler-box > * {
  color: black;
  background-color: black;
  text-shadow: none;
}</style><meta name="generator" content="Hexo 6.1.0"><link rel="alternate" href="/atom.xml" title="Triority's blog" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/favicon.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">124</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">36</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">13</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/services/"><i class="fa-fw fas fa-list"></i><span> 服务</span></a></div><div class="menus_item"><a class="site-page" href="/photo/"><i class="fa-fw fas fa-book"></i><span> 相册</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url('/img/esp32-pinout-chip-ESP-WROOM-32.webp')"><nav id="nav"><span id="blog-info"><a href="/" title="Triority's blog"><img class="site-icon" src="/img/favicon.png"/><span class="site-name">Triority's blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/services/"><i class="fa-fw fas fa-list"></i><span> 服务</span></a></div><div class="menus_item"><a class="site-page" href="/photo/"><i class="fa-fw fas fa-book"></i><span> 相册</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">ESP 32 —— ALL IN ONE</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2023-03-07T10:14:48.000Z" title="发表于 2023-03-07 10:14:48">2023-03-07</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%96%87%E6%A1%A3-%E7%AC%94%E8%AE%B0/">文档&amp;笔记</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%80%BC%E5%BE%97%E4%B8%80%E6%8F%90%E7%9A%84%E6%96%87%E7%AB%A0/">值得一提的文章</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">17k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>74分钟</span></span><span class="post-meta-separator">|</span><span class="leancloud_visitors" id="/2023/esp32-all-in-one/" data-flag-title="ESP 32 —— ALL IN ONE"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span class="leancloud-visitors-count"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这篇文章应该很长，要写很久。我会先列一个框架然后再补充内容，如果一部分写完我就会在目录标题写上<code>已完成</code>，没有标注的不完整或未经确认内容仅供参考。</p>
<p><strong>现在大部分内容都已经完成，就不写已完成标识了———— 2023.6.24补充</strong></p>
<p>在大一的时候做一些小东西一般会用<code>arduino</code>，好似大家都这样做，但是后来就发现<code>esp32</code>是真的香，引脚众多功能齐全计算能力强自带联网，而且性价比极高，价格亲民(此处点名树莓派)，唯一的缺点大概就是可能是电源导致的不稳定。众多功能也就带来了众多科技点要学，所以写这样一篇ALL IN ONE，一方面自己以后要用可以直接拿来用，也可以给初学者作为一个笔记整理甚至指导。</p>
<h1 id="超级无敌基础的操作"><a href="#超级无敌基础的操作" class="headerlink" title="超级无敌基础的操作"></a>超级无敌基础的操作</h1><p>开发板索引地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json</span><br></pre></td></tr></table></figure>
<p>arduino基础</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pinMode(Pin, OUTPUT);</span><br><span class="line">pinMode(Pin,INPUT);</span><br><span class="line">pinMode(Pin,INPUT_PULLUP);</span><br><span class="line"></span><br><span class="line">digitalRead(Pin);</span><br><span class="line">digitalWrite(Pin, HIGH);</span><br><span class="line">analogRead(pin);</span><br><span class="line"></span><br><span class="line">Serial.begin(<span class="number">115200</span>);</span><br><span class="line">Serial.println(val);</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span>&#123;&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<h1 id="引脚和资源分配与使用"><a href="#引脚和资源分配与使用" class="headerlink" title="引脚和资源分配与使用"></a>引脚和资源分配与使用</h1><p><img src="/2023/esp32-all-in-one/esp32-pinout-chip-ESP-WROOM-32.webp" alt="ESP32 模组引脚图"></p>
<h2 id="不建议使用或限制使用的引脚"><a href="#不建议使用或限制使用的引脚" class="headerlink" title="不建议使用或限制使用的引脚"></a>不建议使用或限制使用的引脚</h2><p>不建议使用 <code>Strapping引脚</code> ，<code>SPI flash 引脚</code> 以及 <code>仅输入的引脚</code></p>
<h3 id="Strapping引脚"><a href="#Strapping引脚" class="headerlink" title="Strapping引脚"></a>Strapping引脚</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GPIO 0</span><br><span class="line">GPIO 2</span><br><span class="line">GPIO 4</span><br><span class="line">GPIO 5 (启动时必须为高电平)</span><br><span class="line">GPIO 12 (启动时必须为低电平)</span><br><span class="line">GPIO 15 (启动时必须为高电平)</span><br></pre></td></tr></table></figure>
<p>在硬件上要注意使用外接模块时不能将GPIO12拉高，否则将导致ESP32启动异常。还有一些GPIO在启动或重置时其状态更改为高或者输出PWM信号，在使用时需要注意。</p>
<h3 id="集成在ESP-WROOM-32的SPI-flash引脚"><a href="#集成在ESP-WROOM-32的SPI-flash引脚" class="headerlink" title="集成在ESP-WROOM-32的SPI flash引脚"></a>集成在ESP-WROOM-32的SPI flash引脚</h3><p>GPIO 6 到 GPIO 11 在一些 ESP32 开发板中公开。但是，这些引脚连接到 ESP-WROOM-32 芯片上的集成 SPI 闪存，不推荐用于其他用途。所以，不要在你的项目中使用这些引脚：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GPIO 6 (SCK/CLK)</span><br><span class="line">GPIO 7 (SDO/SD0)</span><br><span class="line">GPIO 8 (SDI/SD1)</span><br><span class="line">GPIO 9 (SHD/SD2)</span><br><span class="line">GPIO 10 (SWP/SD3)</span><br><span class="line">GPIO 11 (CSC/CMD)</span><br></pre></td></tr></table></figure>
<h3 id="仅输入引脚"><a href="#仅输入引脚" class="headerlink" title="仅输入引脚"></a>仅输入引脚</h3><p>GPIO 34 到 39 是 GPI – 仅输入引脚。这些引脚没有内部上拉或下拉电阻。它们不能用作输出，因此只能将这些引脚用作输入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GPIO 34</span><br><span class="line">GPIO 35</span><br><span class="line">GPIO 36</span><br><span class="line">GPIO 39</span><br></pre></td></tr></table></figure>

<h3 id="限制使用引脚"><a href="#限制使用引脚" class="headerlink" title="限制使用引脚"></a>限制使用引脚</h3><p>这些引脚都是ESP32用于引导加载程序或者烧录模式&#x2F;在大多数内置USB&#x2F;Serial的开发板上，不需要担心这些引脚的状态，开发板会把这些引脚设置为正确的状态，以便使用烧录或启动模式。</p>
<p>但是，如果你有外设连接到这些引脚上，当你在尝试上传新代码、用新固件烧写ESP32或重置电路板时可能会遇到麻烦，例如不明原因的错误和失败。可能是因为这些外设阻止ESP32进入正确的模式。</p>
<h2 id="外设资源"><a href="#外设资源" class="headerlink" title="外设资源"></a>外设资源</h2><h3 id="18个ADC通道"><a href="#18个ADC通道" class="headerlink" title="18个ADC通道"></a>18个ADC通道</h3><h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>ESP32 有 18 x 12 位 ADC 输入通道(而ESP8266 只有 1x 10 位 ADC)。这些是可用作 ADC 和相应通道的 GPIO。</p>
<p>尽管 ESP32 有 18 个通道的 ADC，但并非所有 ADC 引脚都可供用户使用。在 8 个 ADC1 通道中，只有 6 个可用(ACD1_CH0 和 ACD1_CH3 到 ACD1_CH7)，而 ADC1_CH1 和 ADC1_CH2 不可用(引脚在 ESP32 开发板中没有暴露)。当使用 ESP32 的 Wi-Fi 时，Wi-Fi Driver 使用 ADC2 Peripheral。因此，只有在未启动 Wi-Fi 驱动程序时才能使用 ADC2。即使您正在使用 ADC2(假设未使用 Wi-Fi)，所有引脚也并非随时可用，因为与 ADC2 相关的一些引脚用于其他重要目的。</p>
<p><img src="/2023/esp32-all-in-one/ESP32_ADC2.png" alt="ADC2引脚其他作用"></p>
<p>ADC 输入通道具有 12 位分辨率。这意味着您可以获得范围从 0 到 4095 的模拟读数，其中 0 对应于 0V，4095 对应于 3.3V。您还可以在代码和 ADC 范围上设置通道的分辨率。但是，ESP32 ADC 引脚没有线性行为。可能无法区分 0 和 0.1V，或 3.2 和 3.3V。<br><img src="/2023/esp32-all-in-one/837a7e8e56af4746a18d3dad41b1ebd3.png" alt="非线性"></p>
<h4 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h4><h5 id="读取模拟值及设置分辨率"><a href="#读取模拟值及设置分辨率" class="headerlink" title="读取模拟值及设置分辨率"></a>读取模拟值及设置分辨率</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line">  <span class="comment">// 设置ADC分辨率,可以是一个介于9(0 - 511)和12位(0 - 4095)之间的值。默认是12位分辨率</span></span><br><span class="line">  <span class="comment">// analogReadResolution(10);</span></span><br><span class="line">  delay(<span class="number">500</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> potValue = analogRead(<span class="number">34</span>);</span><br><span class="line">  Serial.println(potValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="读取模拟电压-毫伏"><a href="#读取模拟电压-毫伏" class="headerlink" title="读取模拟电压(毫伏)"></a>读取模拟电压(毫伏)</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> analogValue=analogReadMilliVolts(<span class="number">34</span>);</span><br><span class="line">  Serial.println(analogValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="设置ADC衰减"><a href="#设置ADC衰减" class="headerlink" title="设置ADC衰减"></a>设置ADC衰减</h5><p>GPIO口会对输入的电压进行一定的减弱,以防止电压过大造成单片机损坏,衰减程度越大,测量的电压范围越大.</p>
<p>默认参数是衰减11db,即使没有设置,也是11db.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置所有ADC引脚的输入衰减</span></span><br><span class="line">analogSetAttenuation(attenuation)</span><br><span class="line"><span class="comment">// 设置pin引脚的输入衰减</span></span><br><span class="line">analogSetPinAttenuation(pin, attenuation)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>attenuation可选值(当VDD_A为3.3V时)：<br><code>ADC_0db</code>: 集没有衰减。ADC可以测量大约800mv<br><code>ADC_2_5db</code>: ADC的输入电压将被衰减，扩展测量范围至约1100 mV<br><code>ADC_6db</code>: ADC的输入电压将被衰减，扩展测量范围至约1350 mV<br><code>ADC_11db</code>: ADC的输入电压将被衰减，扩展测量范围至约2600 mV</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line">  <span class="comment">// 设置GPIO2引脚的衰减</span></span><br><span class="line">  analogSetPinAttenuation(<span class="number">2</span>,ADC_11db);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123; </span><br><span class="line">  <span class="type">int</span> analogValue=analogRead(<span class="number">2</span>);</span><br><span class="line">  Serial.println(analogValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="其他可设置项"><a href="#其他可设置项" class="headerlink" title="其他可设置项"></a>其他可设置项</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置每个样本的循环次数。默认是8。取值范围:1 ~ 255</span></span><br><span class="line">analogSetCycles(cycles)</span><br><span class="line"><span class="comment">//设置范围内的样本数量。默认为1个样本。它有增加灵敏度的作用</span></span><br><span class="line">analogSetSamples(samples)</span><br><span class="line"><span class="comment">//设置ADC时钟的分压器。默认值为1。取值范围:1 ~ 255</span></span><br><span class="line">analogSetClockDiv(attenuation)</span><br><span class="line"><span class="comment">//附加一个引脚到ADC(也清除任何其他模拟模式可能是on)。返回TRUE或FALSE结果</span></span><br><span class="line">adcAttachPin(pin)</span><br><span class="line"><span class="comment">//在附加引脚的总线上启动ADC转换。检查引脚的ADC总线上的转换是否正在运行(返回TRUE或FALSE)。获取转换的结果:返回16位整数</span></span><br><span class="line">adcStart(pin)</span><br><span class="line">adcBusy(pin)</span><br><span class="line">resultadcEnd(pin)</span><br></pre></td></tr></table></figure>
<h3 id="4组SPI接口"><a href="#4组SPI接口" class="headerlink" title="4组SPI接口"></a>4组SPI接口</h3><h4 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h4><p>默认情况下可用的SPI的引脚映射是：</p>
<table>
<thead>
<tr>
<th align="center">SPI</th>
<th align="center">MOSI</th>
<th align="center">MISO</th>
<th align="center">CLK</th>
<th align="center">CS</th>
</tr>
</thead>
<tbody><tr>
<td align="center">VSPI(SPI3)</td>
<td align="center">GPIO 23</td>
<td align="center">GPIO 19</td>
<td align="center">GPIO 18</td>
<td align="center">GPIO 5</td>
</tr>
<tr>
<td align="center">HSPI(SPI2)</td>
<td align="center">GPIO 13</td>
<td align="center">GPIO 12</td>
<td align="center">GPIO 14</td>
<td align="center">GPIO 15</td>
</tr>
</tbody></table>
<p>MISO： 主器件数据输出，从器件数据输入。<br>MOSI：主器件数据输入，从器件数据输出。<br>SCK： 时钟信号，由主设备控制发出。<br>NSS(CS)： 从设备选择信号，由主设备控制。当NSS为低电平则选中从器件。</p>
<p>SPI0和SPI1在内部用于访问ESP32所连接的闪存。两个控制器共享相同的SPI总线信号，并且有一个仲裁器来确定哪个可以访问该总线。</p>
<p>SPI2和SPI3是通用SPI控制器，有时分别称为HSPI和VSPI。它们向用户开放。SPI2和SPI3具有独立的总线信号，分别具有相同的名称。每条总线具有3条CS线，最多能控制6个SPI从设备。</p>
<h4 id="实例-1"><a href="#实例-1" class="headerlink" title="实例"></a>实例</h4><p><img src="/2023/esp32-all-in-one/4ac3c90f138cd7577687727fb046924.jpg" alt="点亮一个1.8寸128*120的TFT屏幕"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;SPI.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Ucglib.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Ucglib8BitPortD ucg(ucg_dev_ili9325_18x240x320_itdb02, ucg_ext_ili9325_18, /* wr= */ 18 , /* cd= */ 19 , /* cs= */ 17, /* reset= */ 16 );</span></span><br><span class="line"><span class="comment">//Ucglib8Bit ucg(ucg_dev_ili9325_18x240x320_itdb02, ucg_ext_ili9325_18, 0, 1, 2, 3, 4, 5, 6, 7, /* wr= */ 18 , /* cd= */ 19 , /* cs= */ 17, /* reset= */ 16 );</span></span><br><span class="line">Ucglib_ST7735_18x128x160_SWSPI <span class="title function_">ucg</span><span class="params">(<span class="comment">/*sclk=*/</span> <span class="number">5</span>, <span class="comment">/*data=*/</span> <span class="number">18</span>, <span class="comment">/*cd=*/</span> <span class="number">21</span>, <span class="comment">/*cs=*/</span> <span class="number">22</span>, <span class="comment">/*reset=*/</span> <span class="number">19</span>)</span>;</span><br><span class="line"><span class="comment">//Ucglib4WireSWSPI ucg(ucg_dev_ili9325_18x240x320_itdb02, ucg_ext_ili9325_18, /*sclk=*/ 13, /*data=*/ 11, /*cd=*/ 9 , /*cs=*/ 10, /*reset=*/ 8);	// not working</span></span><br><span class="line"><span class="comment">//Ucglib4WireSWSPI ucg(ucg_dev_ili9325_spi_18x240x320, ucg_ext_ili9325_spi_18, /*sclk=*/ 13, /*data=*/ 11, /*cd=*/ 9 , /*cs=*/ 10, /*reset=*/ 8);	// not working</span></span><br><span class="line"><span class="comment">//Ucglib3WireILI9325SWSPI ucg(ucg_dev_ili9325_spi_18x240x320, ucg_ext_ili9325_spi_18, /*sclk=*/ 13, /*data=*/ 11, /*cs=*/ 10, /*reset=*/ 8);	// not working</span></span><br><span class="line"><span class="comment">//Ucglib3WireILI9325SWSPI ucg(ucg_dev_ili9325_18x240x320_itdb02, ucg_ext_ili9325_18, /*sclk=*/ 13, /*data=*/ 11, /*cs=*/ 10, /*reset=*/ 8);	// not working</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Ucglib_ST7735_18x128x160_SWSPI ucg(/*sclk=*/ 13, /*data=*/ 11, /*cd=*/ 9, /*cs=*/ 10, /*reset=*/ 8);</span></span><br><span class="line"><span class="comment">//Ucglib_ST7735_18x128x160_HWSPI ucg(/*cd=*/ 9, /*cs=*/ 10, /*reset=*/ 8);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Ucglib_ILI9163_18x128x128_SWSPI ucg(/*sclk=*/ 7, /*data=*/ 6, /*cd=*/ 5, /*cs=*/ 3, /*reset=*/ 4);</span></span><br><span class="line"><span class="comment">//Ucglib_ILI9163_18x128x128_HWSPI ucg(/*cd=*/ 9, /*cs=*/ 10, /*reset=*/ 8);	/* HW SPI Adapter */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Ucglib_ILI9341_18x240x320_SWSPI ucg(/*sclk=*/ 7, /*data=*/ 6, /*cd=*/ 5, /*cs=*/ 3, /*reset=*/ 4);</span></span><br><span class="line"><span class="comment">//Ucglib_ILI9341_18x240x320_SWSPI ucg(/*sclk=*/ 13, /*data=*/ 11, /*cd=*/ 9, /*cs=*/ 10, /*reset=*/ 8);</span></span><br><span class="line"><span class="comment">//Ucglib_ILI9341_18x240x320_HWSPI ucg(/*cd=*/ 9, /*cs=*/ 10, /*reset=*/ 8);</span></span><br><span class="line"><span class="comment">//Ucglib_ILI9341_18x240x320_SWSPI ucg(/*sclk=*/ 4, /*data=*/ 3, /*cd=*/ 6, /*cs=*/ 7, /*reset=*/ 5);	/* Elec Freaks Shield */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Ucglib_HX8352C_18x240x400_SWSPI ucg(/*sclk=*/ 7, /*data=*/ 6, /*cd=*/ 5, /*cs=*/ 3, /*reset=*/ 4);</span></span><br><span class="line"><span class="comment">//Ucglib_HX8352C_18x240x400_HWSPI ucg(/*cd=*/ 9, /*cs=*/ 10, /*reset=*/ 8);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Ucglib_ILI9486_18x320x480_SWSPI ucg(/*sclk=*/ 7, /*data=*/ 6, /*cd=*/ 5, /*cs=*/ 3, /*reset=*/ 4);</span></span><br><span class="line"><span class="comment">//Ucglib_ILI9486_18x320x480_HWSPI ucg(/*cd=*/ 9, /*cs=*/ 10, /*reset=*/ 8);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Ucglib_SSD1351_18x128x128_SWSPI ucg(/*sclk=*/ 13, /*data=*/ 11, /*cd=*/ 9, /*cs=*/ 10, /*reset=*/ 8);</span></span><br><span class="line"><span class="comment">//Ucglib_SSD1351_18x128x128_HWSPI ucg(/*cd=*/ 9, /*cs=*/ 10, /*reset=*/ 8);</span></span><br><span class="line"><span class="comment">//Ucglib_SSD1351_18x128x128_FT_SWSPI ucg(/*sclk=*/ 13, /*data=*/ 11, /*cd=*/ 9, /*cs=*/ 10, /*reset=*/ 8);</span></span><br><span class="line"><span class="comment">//Ucglib_SSD1351_18x128x128_FT_HWSPI ucg(/*cd=*/ 9, /*cs=*/ 10, /*reset=*/ 8);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Ucglib_PCF8833_16x132x132_SWSPI ucg(/*sclk=*/ 13, /*data=*/ 11, /*cs=*/ 9, /*reset=*/ 8);	/* linksprite board */</span></span><br><span class="line"><span class="comment">//Ucglib_PCF8833_16x132x132_HWSPI ucg(/*cs=*/ 9, /*reset=*/ 8);	/* linksprite board */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Ucglib_LD50T6160_18x160x128_6Bit ucg( /*d0 =*/ d0, /*d1 =*/ d1, /*d2 =*/ d2, /*d3 =*/ d3, /*d4 =*/ d4, /*d5 =*/ d5, /*wr=*/ wr, /*cd=*/ cd, /*cs=*/ cs, /*reset=*/ reset);</span></span><br><span class="line"><span class="comment">//Ucglib_LD50T6160_18x160x128_6Bit ucg( /*d0 =*/ 16, /*d1 =*/ 17, /*d2 =*/ 18, /*d3 =*/ 19, /*d4 =*/ 20, /*d5 =*/ 21, /*wr=*/ 14, /*cd=*/ 15); /* Samsung 160x128 OLED with 6Bit minimal interface with Due */</span></span><br><span class="line"><span class="comment">//Ucglib_LD50T6160_18x160x128_6Bit ucg( /*d0 =*/ 5, /*d1 =*/ 4, /*d2 =*/ 3, /*d3 =*/ 2, /*d4 =*/ 1, /*d5 =*/ 0, /*wr=*/ 7, /*cd=*/ 6); /* Samsung 160x128 OLED with 6Bit minimal interface with Uno */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Ucglib_SSD1331_18x96x64_UNIVISION_SWSPI ucg(/*sclk=*/ 13, /*data=*/ 11, /*cd=*/ 9, /*cs=*/ 10, /*reset=*/ 8);</span></span><br><span class="line"><span class="comment">//Ucglib_SSD1331_18x96x64_UNIVISION_HWSPI ucg(/*cd=*/ 9, /*cs=*/ 10, /*reset=*/ 8);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Ucglib_SEPS225_16x128x128_UNIVISION_SWSPI ucg(/*sclk=*/ 13, /*data=*/ 11, /*cd=*/ 9, /*cs=*/ 10, /*reset=*/ 8);</span></span><br><span class="line"><span class="comment">//Ucglib_SEPS225_16x128x128_UNIVISION_HWSPI ucg(/*cd=*/ 9, /*cs=*/ 10, /*reset=*/ 8);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  delay(<span class="number">1000</span>);</span><br><span class="line">  ucg.begin(UCG_FONT_MODE_TRANSPARENT);</span><br><span class="line">  ucg.setColor(<span class="number">0</span>, <span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">  ucg.setColor(<span class="number">1</span>, <span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">  ucg.setColor(<span class="number">2</span>, <span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">  ucg.setColor(<span class="number">3</span>, <span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  Linear Congruential Generator (LCG)</span></span><br><span class="line"><span class="comment">  z = (a*z + c) % m;  </span></span><br><span class="line"><span class="comment">  m = 256 (8 Bit)</span></span><br><span class="line"><span class="comment">  </span></span><br><span class="line"><span class="comment">  for period:</span></span><br><span class="line"><span class="comment">  a-1: dividable by 2</span></span><br><span class="line"><span class="comment">  a-1: multiple of 4</span></span><br><span class="line"><span class="comment">  c: not dividable by 2</span></span><br><span class="line"><span class="comment">  </span></span><br><span class="line"><span class="comment">  c = 17</span></span><br><span class="line"><span class="comment">  a-1 = 64 --&gt; a = 65</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">uint8_t</span> z = <span class="number">127</span>;	<span class="comment">// start value</span></span><br><span class="line"><span class="type">uint8_t</span> <span class="title function_">lcg_rnd</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  z = (<span class="type">uint8_t</span>)((<span class="type">uint16_t</span>)<span class="number">65</span>*(<span class="type">uint16_t</span>)z + (<span class="type">uint16_t</span>)<span class="number">17</span>);</span><br><span class="line">  <span class="keyword">return</span> z;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">draw_text</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  ucg.setFont(ucg_font_ncenR14_tr);</span><br><span class="line">  <span class="comment">//ucg.setColor(255, 255, 255);</span></span><br><span class="line">  ucg.setColor(lcg_rnd(),lcg_rnd(),lcg_rnd());</span><br><span class="line">  ucg.setPrintPos(<span class="number">0</span>,<span class="number">20</span>);</span><br><span class="line">  ucg.print(<span class="string">&quot;The quick brown&quot;</span>);</span><br><span class="line">  ucg.setPrintPos(<span class="number">0</span>,<span class="number">40</span>);</span><br><span class="line">  ucg.print(<span class="string">&quot;fox jumps over&quot;</span>);</span><br><span class="line">  ucg.setPrintPos(<span class="number">0</span>,<span class="number">60</span>);</span><br><span class="line">  ucg.print(<span class="string">&quot;the lazy dog&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">draw_box</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  <span class="type">ucg_int_t</span> x, y, w, h;</span><br><span class="line">  ucg.setColor(lcg_rnd(),lcg_rnd(),lcg_rnd());</span><br><span class="line">  x = lcg_rnd() &amp; <span class="number">31</span>;</span><br><span class="line">  y = lcg_rnd() &amp; <span class="number">31</span>;</span><br><span class="line">  w = <span class="number">63</span>;</span><br><span class="line">  w += lcg_rnd() &amp; <span class="number">31</span>;</span><br><span class="line">  h = <span class="number">63</span>;</span><br><span class="line">  h += lcg_rnd() &amp; <span class="number">31</span>;</span><br><span class="line">  ucg.drawBox(x,y,w, h);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">draw_gradient_box</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  <span class="type">ucg_int_t</span> x, y, w, h;</span><br><span class="line">  <span class="type">static</span> <span class="type">uint8_t</span> idx = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">switch</span>(idx &amp; <span class="number">3</span>)&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>: ucg.setColor(<span class="number">0</span>, lcg_rnd(),lcg_rnd(),lcg_rnd()); <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>: ucg.setColor(<span class="number">1</span>, lcg_rnd(),lcg_rnd(),lcg_rnd()); <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>: ucg.setColor(<span class="number">2</span>, lcg_rnd(),lcg_rnd(),lcg_rnd()); <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>: ucg.setColor(<span class="number">3</span>, lcg_rnd(),lcg_rnd(),lcg_rnd()); <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  idx++;</span><br><span class="line">  x = lcg_rnd() &amp; <span class="number">31</span>;</span><br><span class="line">  y = lcg_rnd() &amp; <span class="number">31</span>;</span><br><span class="line">  w = <span class="number">63</span>;</span><br><span class="line">  w += lcg_rnd() &amp; <span class="number">31</span>;</span><br><span class="line">  h = <span class="number">63</span>;</span><br><span class="line">  h += lcg_rnd() &amp; <span class="number">31</span>;</span><br><span class="line">  ucg.drawGradientBox(x,y,w, h);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// returns FPS*10</span></span><br><span class="line"><span class="type">uint16_t</span> <span class="title function_">measure</span><span class="params">(<span class="type">void</span> (*draw_fn)(<span class="type">void</span>))</span> &#123;</span><br><span class="line">  <span class="type">uint16_t</span> FPS10 = <span class="number">0</span>;</span><br><span class="line">  <span class="type">uint32_t</span> time;</span><br><span class="line"></span><br><span class="line">  ucg.clearScreen();</span><br><span class="line"></span><br><span class="line">  time = millis() + <span class="number">10</span>*<span class="number">1000</span>;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    draw_fn();</span><br><span class="line">    FPS10++;</span><br><span class="line">  &#125; <span class="keyword">while</span>( millis() &lt; time );</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> FPS10;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> u8d_tab[<span class="number">3</span>]  = &#123; <span class="number">100</span>, <span class="number">10</span>, <span class="number">1</span> &#125; ;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *<span class="title function_">u8dp</span><span class="params">(<span class="type">char</span> * dest, <span class="type">uint8_t</span> v)</span>&#123;</span><br><span class="line">  <span class="type">uint8_t</span> pos;</span><br><span class="line">  <span class="type">uint8_t</span> d;</span><br><span class="line">  <span class="type">uint8_t</span> c;</span><br><span class="line">  <span class="keyword">for</span>( pos = <span class="number">0</span>; pos &lt; <span class="number">3</span>; pos++ )</span><br><span class="line">  &#123;</span><br><span class="line">      d = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">      c = *(u8d_tab+pos);</span><br><span class="line">      <span class="keyword">while</span>( v &gt;= c )</span><br><span class="line">      &#123;</span><br><span class="line">	v -= c;</span><br><span class="line">	d++;</span><br><span class="line">      &#125;</span><br><span class="line">      dest[pos] = d;</span><br><span class="line">  &#125;  </span><br><span class="line">  dest[<span class="number">3</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">  <span class="keyword">return</span> dest;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* v = value, d = number of digits */</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *<span class="title function_">u8d</span><span class="params">(<span class="type">uint8_t</span> v, <span class="type">uint8_t</span> d)</span>&#123;</span><br><span class="line">  <span class="type">static</span> <span class="type">char</span> buf[<span class="number">8</span>];</span><br><span class="line">  d = <span class="number">3</span>-d;</span><br><span class="line">  <span class="keyword">return</span> u8dp(buf, v) + d;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *<span class="title function_">convert_FPS</span><span class="params">(<span class="type">uint16_t</span> fps)</span> &#123;</span><br><span class="line">  <span class="type">static</span> <span class="type">char</span> buf[<span class="number">6</span>];</span><br><span class="line">  <span class="built_in">strcpy</span>(buf, u8d( (<span class="type">uint8_t</span>)(fps/<span class="number">10</span>), <span class="number">3</span>));</span><br><span class="line">  buf[<span class="number">3</span>] =  <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">  buf[<span class="number">4</span>] = (fps % <span class="number">10</span>) + <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">  buf[<span class="number">5</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">  <span class="keyword">return</span> buf;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">show_result</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *s, <span class="type">uint16_t</span> fps)</span>  &#123;</span><br><span class="line">  ucg.clearScreen();</span><br><span class="line">  ucg.setFont(ucg_font_helvR18_tr);</span><br><span class="line">  ucg.setColor(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>);</span><br><span class="line">  ucg.setPrintPos(<span class="number">0</span>,<span class="number">25</span>);</span><br><span class="line">  ucg.print(s);</span><br><span class="line">  ucg.setPrintPos(<span class="number">0</span>,<span class="number">50</span>);</span><br><span class="line">  ucg.print(convert_FPS(fps));  </span><br><span class="line">  delay(<span class="number">2000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">  show_result(<span class="string">&quot;Text&quot;</span>, measure(draw_text));</span><br><span class="line">  show_result(<span class="string">&quot;Box&quot;</span>, measure(draw_box));</span><br><span class="line">  show_result(<span class="string">&quot;Gradient&quot;</span>, measure(draw_gradient_box));</span><br><span class="line">  delay(<span class="number">500</span>);</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="3组UART接口"><a href="#3组UART接口" class="headerlink" title="3组UART接口"></a>3组UART接口</h3><h4 id="GPIO"><a href="#GPIO" class="headerlink" title="GPIO"></a>GPIO</h4><p>ESP32里面有3个串口，uart0默认作为log和console输出，我们可以使用uart1和uart2。因为接SPI Flash，会占用GPIO6~GPIO11，所以uart1使用默认管脚的时候会有冲突，我们需要把管脚配置到其它的GPIO上.<br>默认情况下的UART引脚：</p>
<table>
<thead>
<tr>
<th align="center">UART</th>
<th align="center">GPIO</th>
<th align="center">UART</th>
<th align="center">GPIO</th>
</tr>
</thead>
<tbody><tr>
<td align="center">U0_RXD</td>
<td align="center">GPIO3</td>
<td align="center">U0_CTS</td>
<td align="center">GPIO19</td>
</tr>
<tr>
<td align="center">U0_TXD</td>
<td align="center">GPIO1</td>
<td align="center">U0_RTS</td>
<td align="center">GPIO22</td>
</tr>
<tr>
<td align="center">U1_RXD</td>
<td align="center">GPIO9</td>
<td align="center">U1_CTS</td>
<td align="center">GPIO6</td>
</tr>
<tr>
<td align="center">U1_TXD</td>
<td align="center">GPIO10</td>
<td align="center">U1_RTS</td>
<td align="center">GPIO11</td>
</tr>
<tr>
<td align="center">U2_RXD</td>
<td align="center">GPIO16</td>
<td align="center">U2_CTS</td>
<td align="center">GPIO8</td>
</tr>
<tr>
<td align="center">U2_TXD</td>
<td align="center">GPIO17</td>
<td align="center">U2_RTS</td>
<td align="center">GPIO7</td>
</tr>
</tbody></table>
<h4 id="硬件串口重定义"><a href="#硬件串口重定义" class="headerlink" title="硬件串口重定义"></a>硬件串口重定义</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;HardwareSerial.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">HardwareSerial <span class="title function_">SerialPort</span><span class="params">(<span class="number">1</span>)</span>; <span class="comment">// 使用UART1</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span>  &#123;</span><br><span class="line">  <span class="comment">//初始化串口，并重新定义引脚；参数包括波特率、串行模式、RX 引脚和 TX 引脚;串行模式SERIAL_8N1为8位数据位、无校验、1位停止位</span></span><br><span class="line">  SerialPort.begin(<span class="number">115200</span>, SERIAL_8N1, <span class="number">4</span>, <span class="number">2</span>); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span>&#123;</span><br><span class="line">  SerialPort.println(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="使用软件串口"><a href="#使用软件串口" class="headerlink" title="使用软件串口"></a>使用软件串口</h4><p>如果硬件串口不够用可以使用软件串口，但是效率较低</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;SoftwareSerial.h&gt;</span></span></span><br><span class="line"><span class="comment">//实例化软串口</span></span><br><span class="line">SoftwareSerial <span class="title function_">mySerial</span><span class="params">(<span class="number">2</span>, <span class="number">3</span>)</span>; <span class="comment">// RX, TX</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span>&#123;</span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line">  <span class="keyword">while</span> (!Serial) &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Serial.println(<span class="string">&quot;Hello World!&quot;</span>);</span><br><span class="line"></span><br><span class="line">  mySerial.begin(<span class="number">9600</span>);</span><br><span class="line">  mySerial.println(<span class="string">&quot;Hello World?&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (mySerial.available())</span><br><span class="line">    Serial.write(mySerial.read());</span><br><span class="line">  <span class="keyword">if</span> (Serial.available())</span><br><span class="line">    mySerial.write(Serial.read());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在arduino uno使用多个软件串口时，同一时间只能监听一个串口，不知道esp32有没有这个限制，不过需要注意这件事时候你已经用了5个串口通道了，一般人应该都没这个需求吧懒得尝试了</p>
<h3 id="1组I2C接口"><a href="#1组I2C接口" class="headerlink" title="1组I2C接口"></a>1组I2C接口</h3><h4 id="简介-2"><a href="#简介-2" class="headerlink" title="简介"></a>简介</h4><p>ESP32默认的I2C引脚为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GPIO 21 (SDA)</span><br><span class="line">GPIO 22 (SCL)</span><br></pre></td></tr></table></figure>
<p>在ESP32中任何引脚都可以定义为SDA或SCL，但不到逼不得已不推荐这么做。</p>
<p>可在Arduino IDE 中使用以下语句配置其它引脚为SDA或SCL</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Wire.begin(SDA, SCL);</span><br></pre></td></tr></table></figure>
<h4 id="实例-2"><a href="#实例-2" class="headerlink" title="实例"></a>实例</h4><h5 id="主从设备传输"><a href="#主从设备传输" class="headerlink" title="主从设备传输"></a>主从设备传输</h5><h6 id="Wire库方法"><a href="#Wire库方法" class="headerlink" title="Wire库方法"></a>Wire库方法</h6><blockquote>
<p>初始化IIC连接，并作为主机或者从机设备加入IIC总线</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">begin();</span><br><span class="line">begin(address);	<span class="comment">// 当没有填写参数时，设备会以主机模式加人IIC总线；当填写了参数时，设备会以从机模式加入IIC总线，address可以设置为0~127中的任意地址。</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>主机向从机发送数据请求信号</p>
<p>使用 requestFrom() 后，从机端可以使用 onRequest() 注册一个事件用以响应主机的请求；主机可以通过available() 和 read() 函数读取这些数据</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Wire.requestFrom(address, quantity);</span><br><span class="line">Wire.requestFrom(address, quantity, stop); <span class="comment">//quantity请求的字节数；stop当其值为true时将发送一个停止信息，释放IIC总线；当为false时，将发送一个重新开始信息，并继续保持IIC总线的有效连接</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>设定传输数据到指定地址的从机设备</p>
<p>随后可以使用 write() 函数发送数据，并搭配endTransmission()函数结束数据传输</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Wire.beginTransmission(address);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>结束数据传输</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Wire.endTransmission() ;</span><br><span class="line">Wire.endTransmission(stop);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>发送数据</p>
<p>为主机状态时，主机将要发送的数据加入发送队列；当为从机状态时，从机发送数据至发起请求的主机</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Wire.write(value);</span><br><span class="line">Wire.write(<span class="built_in">string</span>);</span><br><span class="line">Wire.write(data, length);</span><br></pre></td></tr></table></figure>
<p>参数：</p>
<ul>
<li>value，以单字节发送。</li>
<li>string，以一系列字节发送。</li>
<li>data，以字节形式发送数组。</li>
<li>length，传输的字节数。<br>返回值：</li>
<li>byte型值，返回输入的字节数。</li>
</ul>
<blockquote>
<p>返回接收到的字节数</p>
<p>在主机中，一般用于主机发送数据请求后；在从机中，一般用于数据接收事件中。</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Wire. available();</span><br></pre></td></tr></table></figure>
<blockquote>
<p>读取1B的数据</p>
<p>在主机中，当使用 requestFrom() 函数发送数据请求信号后，需要使用 read() 函数来获取数据；在从机中需要使用该函数读取主机发送来的数据</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Wire.read()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>从机端注册一个事件，当从机收到主机发送的数据时即被触发</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Wire.onReceive(handler);</span><br></pre></td></tr></table></figure>
<p>参数：</p>
<ul>
<li>handler，当从机接收到数据时可被触发的事件。该事件带有一个int型参数(从主机读到的字节数)且没有返回值，如 <code>void myHandler(int numBytes)</code></li>
</ul>
<blockquote>
<p>注册一个事件,当从机接收到主机的数据请求时即被触发</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Wire.onRequest(handler);</span><br></pre></td></tr></table></figure>
<p>参数：</p>
<ul>
<li>handler，可被触发的事件。该事件不带参数和返回值，如 <code>voidmyHandler()</code></li>
</ul>
<h6 id="主从收发"><a href="#主从收发" class="headerlink" title="主从收发"></a>主从收发</h6><blockquote>
<p>主发从收</p>
</blockquote>
<ul>
<li>主机：<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 直接在Arduino IDE选择“文件”→“示例”→Wire→master_writer可以打开该文件</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Wire.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  Wire.begin(); 					<span class="comment">// Wire初始化，作为主机加入到IIC总线</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">byte x = <span class="number">0</span>;							<span class="comment">// 定义一个byte变量以便串口调试</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  Wire.beginTransmission(<span class="number">8</span>); 		<span class="comment">// 向地址为8的从机传送数据</span></span><br><span class="line">  Wire.write(<span class="string">&quot;x is &quot;</span>);        		<span class="comment">// 发送5B的字符串</span></span><br><span class="line">  Wire.write(x);              		<span class="comment">// 发送1B的数据</span></span><br><span class="line">  Wire.endTransmission();    		<span class="comment">// 结束传送</span></span><br><span class="line">  </span><br><span class="line">  x++;</span><br><span class="line">  delay(<span class="number">500</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>从机：<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 直接在Arduino IDE选择“文件”→“示例”→Wire→slave_receiver，可以打开该文件</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Wire.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  Wire.begin(<span class="number">8</span>);                <span class="comment">// Wire初始化, 并以从设备地址8的身份加入IIc总线</span></span><br><span class="line">  Wire.onReceive(receiveEvent); <span class="comment">// 注册一个IIC事件，用于响应主机的数据发送</span></span><br><span class="line">  Serial.begin(<span class="number">9600</span>);           <span class="comment">// 初始化串口并设置波特率为9600</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  delay(<span class="number">100</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当主机发送的数据被收到时，将触发 receiveEvent() 事件</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">receiveEvent</span><span class="params">(<span class="type">int</span> howMany)</span> &#123;</span><br><span class="line"><span class="comment">// 循环读取收到的数据，最后一个数据单独读取</span></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span> &lt; Wire.available()) &#123; </span><br><span class="line">    <span class="type">char</span> c = Wire.read(); 			<span class="comment">// 以字符形式接收数据</span></span><br><span class="line">    Serial.print(c);         		<span class="comment">// 串口输出该字符串</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">int</span> x = Wire.read();    			<span class="comment">// 以整型形式接收数据</span></span><br><span class="line">  Serial.println(x);         		<span class="comment">// 串口输出该整型变量</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>主收从发</p>
</blockquote>
<ul>
<li><p>主机：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 直接在Arduino IDE选择“文件”→“示例”→Wire→master_reader，可以打开该文件</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Wire.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  Wire.begin();        <span class="comment">// Wire初始化，作为主机加入到IIC总线</span></span><br><span class="line">  Serial.begin(<span class="number">9600</span>);  <span class="comment">// 初始化串口并设置波特率为9600</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  Wire.requestFrom(<span class="number">8</span>, <span class="number">6</span>);    <span class="comment">// 向8号机请求6B的数据</span></span><br><span class="line">	<span class="comment">// 等待从机发送数据</span></span><br><span class="line">  <span class="keyword">while</span> (Wire.available()) &#123; </span><br><span class="line">    <span class="type">char</span> c = Wire.read(); 		<span class="comment">// 以字符形式接受并读取从机发来的一个字节的数据</span></span><br><span class="line">    Serial.print(c);         	<span class="comment">// 串口输出该字符</span></span><br><span class="line">  &#125;</span><br><span class="line">  Serial.println();				<span class="comment">// 换行</span></span><br><span class="line">  delay(<span class="number">500</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>从机：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 直接在Arduino IDE选择“文件”→“示例”→Wire→slave_sender，可以打开该文件</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Wire.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  Wire.begin(<span class="number">8</span>);                <span class="comment">// Wire初始化, 并以从设备地址#8的身份加入i2c总线</span></span><br><span class="line">  Wire.onRequest(requestEvent); <span class="comment">// 注册一个IIC事件，用于响应主机的数据请求</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  delay(<span class="number">100</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//每当主机请求数据时,该函数便会执行</span></span><br><span class="line"><span class="comment">//在setup()中,该函数被注册为一个事件</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">requestEvent</span><span class="params">()</span> &#123;</span><br><span class="line">  Wire.write(<span class="string">&quot;hello &quot;</span>); <span class="comment">// 用6B的信息回应主机的请求，hello后带一个空格</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h6 id="应答交互通讯"><a href="#应答交互通讯" class="headerlink" title="应答交互通讯"></a>应答交互通讯</h6><blockquote>
<p>这个程序用于iic控制电机驱动，主机是一个uno，负责发送目标速度，从机是电机驱动板，负责返回当前角度</p>
<p>其中电机驱动板使用了TwoWire来创建两个iic通道</p>
</blockquote>
</li>
<li><p>uno：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Wire.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span>&#123;</span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line">  Wire.begin(); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span>&#123;</span><br><span class="line">  String inString=<span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="keyword">while</span>(Serial.available()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">    inString += <span class="type">char</span>(Serial.read());</span><br><span class="line">    delay(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(inString!=<span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line">    Serial.print(<span class="string">&quot;IIC send:&quot;</span>);</span><br><span class="line">    Serial.println(inString);</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* cstr = inString.c_str();</span><br><span class="line">    Wire.beginTransmission(<span class="number">1</span>);</span><br><span class="line">    Wire.write(cstr);</span><br><span class="line">    Wire.endTransmission();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  String recString=<span class="string">&quot;&quot;</span>;</span><br><span class="line">  Wire.requestFrom(<span class="number">1</span>, <span class="number">8</span>);</span><br><span class="line">  <span class="keyword">while</span> (Wire.available()) &#123; </span><br><span class="line">    recString += <span class="type">char</span>(Wire.read());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(recString!=<span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line">    Serial.print(<span class="string">&quot;IIC received:&quot;</span>);</span><br><span class="line">    Serial.println(recString.toInt());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>esp32驱动板：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;SimpleFOC.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Wire.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dummy.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">MagneticSensorI2C sensor = MagneticSensorI2C(AS5600_I2C);</span><br><span class="line"></span><br><span class="line">BLDCMotor motor = BLDCMotor(<span class="number">11</span>);</span><br><span class="line">BLDCDriver3PWM driver = BLDCDriver3PWM(<span class="number">25</span>, <span class="number">26</span>, <span class="number">27</span>, <span class="number">14</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> target_velocity = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">TwoWire Wire_foc = TwoWire(<span class="number">0</span>);</span><br><span class="line">TwoWire Wire_rec = TwoWire(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line"></span><br><span class="line">  Wire_rec.setPins(<span class="number">16</span>,<span class="number">17</span>);</span><br><span class="line">  Wire_rec.begin(<span class="number">1</span>);</span><br><span class="line">  Wire_rec.onReceive(receiveEvent);</span><br><span class="line">  Wire_rec.onRequest(requestEvent);</span><br><span class="line"></span><br><span class="line">  Wire_foc.setPins(<span class="number">33</span>,<span class="number">32</span>);</span><br><span class="line">  Wire_foc.begin();</span><br><span class="line">  sensor.init(&amp;Wire_foc);</span><br><span class="line"></span><br><span class="line">  motor.linkSensor(&amp;sensor);</span><br><span class="line"></span><br><span class="line">  driver.voltage_power_supply = <span class="number">12</span>;</span><br><span class="line">  driver.init();</span><br><span class="line"></span><br><span class="line">  motor.linkDriver(&amp;driver);</span><br><span class="line"></span><br><span class="line">  motor.controller = MotionControlType::velocity;</span><br><span class="line"></span><br><span class="line">  motor.PID_velocity.P = <span class="number">0.2f</span>;</span><br><span class="line">  motor.PID_velocity.I = <span class="number">20</span>;</span><br><span class="line">  motor.PID_velocity.D = <span class="number">0</span>;</span><br><span class="line">  motor.voltage_limit = <span class="number">6</span>;</span><br><span class="line">  motor.PID_velocity.output_ramp = <span class="number">1000</span>;</span><br><span class="line">  motor.LPF_velocity.Tf = <span class="number">0.01f</span>;</span><br><span class="line"></span><br><span class="line">  motor.init();</span><br><span class="line">  motor.initFOC();</span><br><span class="line"></span><br><span class="line">  _delay(<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  motor.loopFOC();</span><br><span class="line"></span><br><span class="line">  motor.move(target_velocity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">receiveEvent</span><span class="params">(<span class="type">int</span> howMany)</span> &#123;</span><br><span class="line">  String inString=<span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="comment">//Serial.println(&quot;IIC received:&quot;);</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i=howMany;i&gt;<span class="number">1</span>;i--)&#123;</span><br><span class="line">    inString += <span class="type">char</span>(Wire_rec.read());</span><br><span class="line">  &#125;</span><br><span class="line">    target_velocity = inString.toFloat()/<span class="number">100</span>;</span><br><span class="line">    inString=<span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">requestEvent</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">float</span> get_ang = sensor.getAngle();</span><br><span class="line">  <span class="type">int</span> ang = <span class="type">int</span>(get_ang*<span class="number">100</span>);</span><br><span class="line">  Serial.println(ang);</span><br><span class="line">  <span class="type">char</span> cstr[<span class="number">8</span>];</span><br><span class="line">  itoa(ang, cstr, <span class="number">10</span>);</span><br><span class="line">  Wire_rec.write(cstr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="as5600编码器"><a href="#as5600编码器" class="headerlink" title="as5600编码器"></a>as5600编码器</h5><p>此程序为读取<code>as5600</code>磁编码器的i2c数据，其中SDA为D22，SCL为D23：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;AS5600.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Wire.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">AS5600 as5600;   <span class="comment">//  use default Wire</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span>&#123;</span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line">  Serial.println(__FILE__);</span><br><span class="line">  Serial.print(<span class="string">&quot;AS5600_LIB_VERSION: &quot;</span>);</span><br><span class="line">  Serial.println(AS5600_LIB_VERSION);</span><br><span class="line">  <span class="comment">//  ESP32</span></span><br><span class="line">  as5600.begin(<span class="number">22</span>,<span class="number">23</span>);</span><br><span class="line">  <span class="comment">//  AVR</span></span><br><span class="line">  <span class="comment">//  as5600.begin(4);  //  set direction pin</span></span><br><span class="line">  as5600.setDirection(AS5600_CLOCK_WISE);  <span class="comment">// default, just be explicit.</span></span><br><span class="line">  <span class="type">int</span> b = as5600.isConnected();</span><br><span class="line">  Serial.print(<span class="string">&quot;Connect: &quot;</span>);</span><br><span class="line">  Serial.println(b);</span><br><span class="line">  delay(<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="comment">//  Serial.print(millis());</span></span><br><span class="line">  Serial.println(as5600.rawAngle() * AS5600_RAW_TO_DEGREES);</span><br><span class="line">  delay(<span class="number">100</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="oled屏幕"><a href="#oled屏幕" class="headerlink" title="oled屏幕"></a>oled屏幕</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Wire.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;SSD1306.h&quot;</span></span></span><br><span class="line"><span class="comment">// 声明类SSD1306的对象,参数为:地址,SDA,SCL</span></span><br><span class="line">SSD1306 <span class="title function_">display</span><span class="params">(<span class="number">0x3c</span>, <span class="number">21</span>, <span class="number">22</span>)</span>;</span><br><span class="line">SSD1306 <span class="title function_">display2</span><span class="params">(<span class="number">0x3c</span>, <span class="number">18</span>, <span class="number">19</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span>&#123;</span><br><span class="line">  display.init();</span><br><span class="line">  display.setFont(ArialMT_Plain_24);</span><br><span class="line">  display.drawString(<span class="number">32</span>, <span class="number">0</span>, <span class="string">&quot;ctrl+v&quot;</span>);</span><br><span class="line">  display.display();</span><br><span class="line"></span><br><span class="line">  display2.init();</span><br><span class="line">  display2.setFont(ArialMT_Plain_24);</span><br><span class="line">  display2.drawString(<span class="number">32</span>, <span class="number">0</span>, <span class="string">&quot;ctrl+c&quot;</span>);</span><br><span class="line">  display2.display();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span>&#123;</span><br><span class="line">  delay(<span class="number">1000</span>);</span><br><span class="line">  display.clear();</span><br><span class="line">  display.drawString(<span class="number">32</span>, <span class="number">0</span>, <span class="string">&quot;ctrl+c&quot;</span>);</span><br><span class="line">  display.display();</span><br><span class="line">  delay(<span class="number">1000</span>);</span><br><span class="line">  display.clear();</span><br><span class="line">  display.drawString(<span class="number">32</span>, <span class="number">0</span>, <span class="string">&quot;ctrl+v&quot;</span>);</span><br><span class="line">  display.display();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="16个PWM通道"><a href="#16个PWM通道" class="headerlink" title="16个PWM通道"></a>16个PWM通道</h3><h4 id="简介-3"><a href="#简介-3" class="headerlink" title="简介"></a>简介</h4><p>ESP32 PWM 控制器有 8 个高速通道(80MHz)和 8 个低速通道(1MHz)，我们总共有 16 个通道。它们根据速度分为两组。每组有 4 个定时器&#x2F;8 个通道。这意味着每两个通道共享同一个定时器。因此，我们无法独立控制每对通道的 PWM 频率。<br>所有可以作为输出的引脚都可以用作 PWM 引脚(GPIO 34 到 39 不能产生 PWM)。</p>
<h4 id="实例-3"><a href="#实例-3" class="headerlink" title="实例"></a>实例</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> freq = <span class="number">50</span>;  <span class="comment">//频率</span></span><br><span class="line"><span class="type">int</span> channel = <span class="number">8</span>;  <span class="comment">//使用的通道</span></span><br><span class="line"><span class="type">int</span> resolution = <span class="number">8</span>; <span class="comment">// 8位分辨率，可以使用0到255的值来控制</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> servo = <span class="number">12</span>; <span class="comment">//输出引脚</span></span><br><span class="line">ledcSetup(channel, freq, resolution); <span class="comment">//初始化</span></span><br><span class="line">ledcAttachPin(servo, channel);  <span class="comment">//指定通道与引脚</span></span><br><span class="line">ledcWrite(channel, <span class="number">127</span>);  <span class="comment">//输出50%的PWM</span></span><br></pre></td></tr></table></figure>
<p>顺便赠送一个使用舵机的函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">servoPWM</span><span class="params">(<span class="type">int</span> degree)</span></span><br><span class="line">&#123; <span class="comment">// 0-180度</span></span><br><span class="line">  <span class="comment">// 20ms周期，高电平0.5-2.5ms，对应0-180度角度</span></span><br><span class="line">  <span class="type">const</span> <span class="type">float</span> deadZone = <span class="number">6.4</span>;<span class="comment">//对应0.5ms(0.5ms/(20ms/256))</span></span><br><span class="line">  <span class="type">const</span> <span class="type">float</span> max = <span class="number">32</span>;<span class="comment">//对应2.5ms</span></span><br><span class="line">  <span class="keyword">if</span> (degree &lt; <span class="number">60</span>)</span><br><span class="line">    degree = <span class="number">60</span>;</span><br><span class="line">  <span class="keyword">if</span> (degree &gt; <span class="number">120</span>)</span><br><span class="line">    degree = <span class="number">120</span>;</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">int</span>)(((max - deadZone) / <span class="number">180</span>) * degree + deadZone);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2个DAC"><a href="#2个DAC" class="headerlink" title="2个DAC"></a>2个DAC</h3><h4 id="简介-4"><a href="#简介-4" class="headerlink" title="简介"></a>简介</h4><p>ESP32 上有 2 x 8 位 DAC 通道，用于将数字信号转换为模拟电压信号输出。这些是 DAC 通道：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DAC1 (GPIO25)</span><br><span class="line">DAC2 (GPIO26)</span><br></pre></td></tr></table></figure>
<h4 id="实例-4"><a href="#实例-4" class="headerlink" title="实例"></a>实例</h4><p>输出电压将在<code>0-3.3V</code>之间变化：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span>&#123;&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> dutyCycle = <span class="number">0</span>; dutyCycle &lt;= <span class="number">255</span>; dutyCycle = dutyCycle + <span class="number">1</span>)&#123;</span><br><span class="line">    dacWrite(<span class="number">25</span>, dutyCycle);</span><br><span class="line">    delay(<span class="number">50</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> dutyCycle = <span class="number">255</span>; dutyCycle &gt;= <span class="number">0</span>; dutyCycle = dutyCycle - <span class="number">1</span>)&#123;</span><br><span class="line">    dacWrite(<span class="number">25</span>, dutyCycle);</span><br><span class="line">    delay(<span class="number">50</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="10个电容感应GPIO"><a href="#10个电容感应GPIO" class="headerlink" title="10个电容感应GPIO"></a>10个电容感应GPIO</h3><h4 id="简介-5"><a href="#简介-5" class="headerlink" title="简介"></a>简介</h4><p>ESP32 有 10 个内部电容式触摸传感器。它们可以感知任何带电荷的物体的变化，比如人体皮肤。因此，他们可以检测用手指触摸 GPIO 时引起的变化。这些引脚可以集成到电容式焊盘中并取代机械按钮。电容式触控引脚还可用于将 ESP32 从深度睡眠中唤醒</p>
</li>
</ul>
<p>这些内部触摸传感器连接到这些 GPIO：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">T0 (GPIO 4)</span><br><span class="line">T1 (GPIO 0)</span><br><span class="line">T2 (GPIO 2)</span><br><span class="line">T3 (GPIO 15)</span><br><span class="line">T4 (GPIO 13)</span><br><span class="line">T5 (GPIO 12)</span><br><span class="line">T6 (GPIO 14)</span><br><span class="line">T7 (GPIO 27)</span><br><span class="line">T8 (GPIO 33)</span><br><span class="line">T9 (GPIO 32)</span><br></pre></td></tr></table></figure>
<h4 id="实例-5"><a href="#实例-5" class="headerlink" title="实例"></a>实例</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// set pin numbers(D4/T0)</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> touchPin = <span class="number">4</span>;</span><br><span class="line"><span class="comment">// change with your threshold value</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> threshold = <span class="number">20</span>;</span><br><span class="line"><span class="comment">// variable for storing the touch pin value</span></span><br><span class="line"><span class="type">int</span> touchValue;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span>&#123;</span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line">  delay(<span class="number">1000</span>); <span class="comment">// bring up serial monitor</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span>&#123;</span><br><span class="line">  touchValue = touchRead(touchPin);</span><br><span class="line">  Serial.print(touchValue);</span><br><span class="line">  <span class="keyword">if</span>(touchValue &lt; threshold)&#123;</span><br><span class="line">    Serial.println(<span class="string">&quot;on&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span>&#123;</span><br><span class="line">    Serial.println(<span class="string">&quot;off&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  delay(<span class="number">500</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="中断"><a href="#中断" class="headerlink" title="中断"></a>中断</h3><h4 id="简介-6"><a href="#简介-6" class="headerlink" title="简介"></a>简介</h4><p>所有引脚都可以配置为中断。</p>
<p>中断函数:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">attachInterrupt(digitalPinToInterrupt(GPIO), function, mode);</span><br></pre></td></tr></table></figure>
<p>其中参数<code>mode</code>有5种：</p>
<ul>
<li><code>LOW</code>：每当引脚为LOW时触发中断；</li>
<li><code>HIGH</code>：每当引脚为高电平时触发中断；</li>
<li><code>CHANGE</code>：每当引脚值发生变化时触发中断——例如从高电平变为低电平或从低电平变为高电平；</li>
<li><code>FALLING</code>：当引脚从高电平变为低电平时；</li>
<li><code>RISING</code>: 当引脚从低电平变为高电平时触发。</li>
</ul>
<h4 id="实例-6"><a href="#实例-6" class="headerlink" title="实例"></a>实例</h4><h5 id="外部引脚中断"><a href="#外部引脚中断" class="headerlink" title="外部引脚中断"></a>外部引脚中断</h5><blockquote>
<p>此处内容在2023.10.30进行了修改</p>
</blockquote>
<p>程序目的是在引脚上升沿输出开机毫秒数</p>
<p>有个小问题就是如果在中断函数使用串口输出极易导致中断看门狗复位，因此应该在中断函数中只进行计时并保存，串口输出交给loop循环</p>
<p>这是错误的程序：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">long</span> t;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Button</span> &#123;</span></span><br><span class="line">	<span class="type">const</span> <span class="type">uint8_t</span> PIN;</span><br><span class="line">	<span class="type">uint32_t</span> numberKeyPresses;</span><br><span class="line">	<span class="type">bool</span> pressed;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Button button1 = &#123;<span class="number">18</span>, <span class="number">0</span>, <span class="literal">false</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> IRAM_ATTR <span class="title function_">isr</span><span class="params">()</span> &#123;</span><br><span class="line">	button1.numberKeyPresses++;</span><br><span class="line">	button1.pressed = <span class="literal">true</span>;</span><br><span class="line">  t = micros();</span><br><span class="line">  Serial.println(t);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">	Serial.begin(<span class="number">115200</span>);</span><br><span class="line">	pinMode(button1.PIN, INPUT_PULLUP);</span><br><span class="line">	attachInterrupt(button1.PIN, isr, FALLING);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> (button1.pressed) &#123;</span><br><span class="line">		Serial.<span class="built_in">printf</span>(<span class="string">&quot;Button has been pressed %u times\n&quot;</span>, button1.numberKeyPresses);</span><br><span class="line">		button1.pressed = <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>具体报错如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">17:24:50.601 -&gt; Guru Meditation Error: Core  1 panic&#x27;ed (Interrupt wdt timeout on CPU1). </span><br><span class="line">17:24:50.601 -&gt; </span><br><span class="line">17:24:50.601 -&gt; Core  1 register dump:</span><br><span class="line">17:24:50.642 -&gt; PC      : 0x4008ab8a  PS      : 0x00060b35  A0      : 0x80089b02  A1      : 0x3ffbf0ec  </span><br><span class="line">17:24:50.642 -&gt; A2      : 0x3ffb8314  A3      : 0x3ffb81a4  A4      : 0x00000004  A5      : 0x00060b23  </span><br><span class="line">17:24:50.642 -&gt; A6      : 0x00060b23  A7      : 0x00000001  A8      : 0x3ffb81a4  A9      : 0x00000018  </span><br><span class="line">17:24:50.642 -&gt; A10     : 0x3ffb81a4  A11     : 0x00000018  A12     : 0x3ffc22fc  A13     : 0x00060b23  </span><br><span class="line">17:24:50.642 -&gt; A14     : 0x007bf308  A15     : 0x003fffff  SAR     : 0x0000000e  EXCCAUSE: 0x00000006  </span><br><span class="line">17:24:50.667 -&gt; EXCVADDR: 0x00000000  LBEG    : 0x400863fd  LEND    : 0x4008640d  LCOUNT  : 0xfffffffd  </span><br><span class="line">17:24:50.667 -&gt; Core  1 was running in ISR context:</span><br><span class="line">17:24:50.667 -&gt; EPC1    : 0x400da62f  EPC2    : 0x00000000  EPC3    : 0x00000000  EPC4    : 0x00000000</span><br><span class="line">17:24:50.667 -&gt; </span><br><span class="line">17:24:50.667 -&gt; </span><br><span class="line">17:24:50.667 -&gt; Backtrace: 0x4008ab87:0x3ffbf0ec |&lt;-CORRUPTED</span><br><span class="line">17:24:50.667 -&gt; </span><br><span class="line">17:24:50.667 -&gt; </span><br><span class="line">17:24:50.667 -&gt; Core  0 register dump:</span><br><span class="line">17:24:50.667 -&gt; PC      : 0x4008ad27  PS      : 0x00060035  A0      : 0x8008972b  A1      : 0x3ffbea2c  </span><br><span class="line">17:24:50.700 -&gt; A2      : 0x3ffbf308  A3      : 0xb33fffff  A4      : 0x0000abab  A5      : 0x00060023  </span><br><span class="line">17:24:50.700 -&gt; A6      : 0x00060021  A7      : 0x0000cdcd  A8      : 0x0000abab  A9      : 0xffffffff  </span><br><span class="line">17:24:50.700 -&gt; A10     : 0x3ffc2118  A11     : 0x00000000  A12     : 0x3ffc2114  A13     : 0x00000007  </span><br><span class="line">17:24:50.700 -&gt; A14     : 0x007bf308  A15     : 0x003fffff  SAR     : 0x0000001d  EXCCAUSE: 0x00000006  </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>应该改成这样：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">long</span> t;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Button</span> &#123;</span></span><br><span class="line">	<span class="type">const</span> <span class="type">uint8_t</span> PIN;</span><br><span class="line">	<span class="type">uint32_t</span> numberKeyPresses;</span><br><span class="line">	<span class="type">bool</span> pressed;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Button button1 = &#123;<span class="number">18</span>, <span class="number">0</span>, <span class="literal">false</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> IRAM_ATTR <span class="title function_">isr</span><span class="params">()</span> &#123;</span><br><span class="line">	button1.numberKeyPresses++;</span><br><span class="line">	button1.pressed = <span class="literal">true</span>;</span><br><span class="line">  t = micros();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">	Serial.begin(<span class="number">115200</span>);</span><br><span class="line">	pinMode(button1.PIN, INPUT_PULLUP);</span><br><span class="line">	attachInterrupt(button1.PIN, isr, FALLING);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> (button1.pressed) &#123;</span><br><span class="line">		Serial.<span class="built_in">printf</span>(<span class="string">&quot;Button has been pressed %u times\n&quot;</span>, button1.numberKeyPresses);</span><br><span class="line">		button1.pressed = <span class="literal">false</span>;</span><br><span class="line">    Serial.println(t);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还有要注意的就是time不能作为变量名否则报错，在这件事情上折腾好久没想起来time居然是个函数这件事</p>
<h5 id="定时器中断"><a href="#定时器中断" class="headerlink" title="定时器中断"></a>定时器中断</h5><p>定时器每秒触发一次中断</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义定时器指针</span></span><br><span class="line"><span class="type">hw_timer_t</span> *timer = <span class="literal">NULL</span>;</span><br><span class="line"><span class="comment">//中断函数</span></span><br><span class="line"><span class="type">void</span> IRAM_ATTR <span class="title function_">InterruptEvent</span><span class="params">()</span>&#123;</span><br><span class="line">  Serial.println(<span class="string">&quot;BEEP&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span>&#123;</span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line">  <span class="comment">//定时器初始化--esp32频率为80Mhz，分频80则时间单位为1Mhz，即1us即10^-6s，下面的1000000us即1s。</span></span><br><span class="line">  timer = timerBegin(<span class="number">0</span>, <span class="number">80</span>, <span class="literal">true</span>);</span><br><span class="line">  <span class="comment">//中断绑定定时器</span></span><br><span class="line">  timerAttachInterrupt(timer, &amp;InterruptEvent, <span class="literal">true</span>);</span><br><span class="line">  <span class="comment">//1s进入一次中断--注意这里不能用另一个函数：timerWrite（timer,1000000）；实测用这个函数不行</span></span><br><span class="line">  timerAlarmWrite(timer, <span class="number">1000000</span>, <span class="literal">true</span>);</span><br><span class="line">  <span class="comment">//使能定时器             </span></span><br><span class="line">  timerAlarmEnable(timer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="不常用内容"><a href="#不常用内容" class="headerlink" title="不常用内容"></a>不常用内容</h3><h4 id="2个I2S-高速数位音讯传输标准协议"><a href="#2个I2S-高速数位音讯传输标准协议" class="headerlink" title="2个I2S:高速数位音讯传输标准协议"></a>2个I2S:高速数位音讯传输标准协议</h4><p>在ESP32引脚上实际是标记为 DAC1 和 DAC2</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GPIO 25</span><br><span class="line">GPIO 26</span><br></pre></td></tr></table></figure>

<h4 id="16个RTC的GPIO"><a href="#16个RTC的GPIO" class="headerlink" title="16个RTC的GPIO"></a>16个RTC的GPIO</h4><p>ESP32 上有 RTC GPIO 支持。当 ESP32 处于深度睡眠时，可以使用路由到 RTC 低功耗子系统的 GPIO。当超低功耗 (ULP) 协处理器运行时，这些 RTC GPIO 可用于将 ESP32 从深度睡眠中唤醒。以下 GPIO 可用作外部唤醒源</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">RTC_GPIO0 (GPIO36)</span><br><span class="line">RTC_GPIO3 (GPIO39)</span><br><span class="line">RTC_GPIO4 (GPIO34)</span><br><span class="line">RTC_GPIO5 (GPIO35)</span><br><span class="line">RTC_GPIO6 (GPIO25)</span><br><span class="line">RTC_GPIO7 (GPIO26)</span><br><span class="line">RTC_GPIO8 (GPIO33)</span><br><span class="line">RTC_GPIO9 (GPIO32)</span><br><span class="line">RTC_GPIO10 (GPIO4)</span><br><span class="line">RTC_GPIO11 (GPIO0)</span><br><span class="line">RTC_GPIO12 (GPIO2)</span><br><span class="line">RTC_GPIO13 (GPIO15)</span><br><span class="line">RTC_GPIO14 (GPIO13)</span><br><span class="line">RTC_GPIO15 (GPIO12)</span><br><span class="line">RTC_GPIO16 (GPIO14)</span><br><span class="line">RTC_GPIO17 (GPIO27)</span><br></pre></td></tr></table></figure>
<h4 id="内置2个霍尔传感器"><a href="#内置2个霍尔传感器" class="headerlink" title="内置2个霍尔传感器"></a>内置2个霍尔传感器</h4><p>内置霍尔效应传感器，可检测周围磁场的变化。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GPIO 36 (VP)</span><br><span class="line">GPIO 39 (VN)</span><br></pre></td></tr></table></figure>

<h4 id="使能EN"><a href="#使能EN" class="headerlink" title="使能EN"></a>使能EN</h4><p>3.3V 稳压器的启用引脚。它被拉高，因此接地以禁用 3.3V 稳压器。这意味着可以使用连接到按钮的此引脚来重新启动 ESP32。</p>
<h4 id="GPIO电流"><a href="#GPIO电流" class="headerlink" title="GPIO电流"></a>GPIO电流</h4><p>根据 ESP32 数据表中的“推荐操作条件”部分，每个 GPIO 的绝对最大电流消耗为 40mA。</p>
<h1 id="软件应用"><a href="#软件应用" class="headerlink" title="软件应用"></a>软件应用</h1><h2 id="技术栈"><a href="#技术栈" class="headerlink" title="技术栈"></a>技术栈</h2><h3 id="按钮消抖"><a href="#按钮消抖" class="headerlink" title="按钮消抖"></a>按钮消抖</h3><p>上面的代码经常用于读取按钮是否被按下，但是实际上机械按钮在开关时总会因为各种原因导致的抖动，导致多次触发中断。</p>
<p>我解决这个问题的想法就是先检查最近50ms有没有过中断，如果没有，继续检查接下来20ms有没有回到高电平，如果还没有，就可以判定确实按下了按钮。代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">long</span> previousMillis = <span class="number">0</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span>&#123;</span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line">  pinMode(<span class="number">12</span>, INPUT|PULLUP );</span><br><span class="line">  attachInterrupt(<span class="number">12</span>, blink, FALLING);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">blink</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="type">int</span> ding = <span class="number">1</span>;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> currentMillis = millis();</span><br><span class="line">  <span class="keyword">if</span> (currentMillis - previousMillis &gt; <span class="number">50</span>)&#123;</span><br><span class="line">    <span class="keyword">while</span>(millis() - currentMillis &lt; <span class="number">20</span>)&#123;</span><br><span class="line">      <span class="keyword">if</span> (digitalRead(<span class="number">12</span>)==<span class="number">1</span>)&#123;</span><br><span class="line">        ding = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(ding)&#123;</span><br><span class="line">      previousMillis = currentMillis;</span><br><span class="line">      Serial.println(<span class="string">&quot;interrupt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="光污染制作–ws2812驱动"><a href="#光污染制作–ws2812驱动" class="headerlink" title="光污染制作–ws2812驱动"></a>光污染制作–ws2812驱动</h3><p>讲真这个和ESP32关系不大，但是我就想写怎么着hhh</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Freenove_WS2812_Lib_for_ESP32.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LEDS_COUNT  128    <span class="comment">//彩灯数目</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LEDS_PIN	13    <span class="comment">//ESP32控制ws2812的引脚</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHANNEL		0    <span class="comment">//控制通道，最多8路</span></span></span><br><span class="line"></span><br><span class="line">Freenove_ESP32_WS2812 strip = Freenove_ESP32_WS2812(LEDS_COUNT, LEDS_PIN, CHANNEL, TYPE_GRB);<span class="comment">//申请一个彩灯控制对象</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  strip.begin();      <span class="comment">//初始化彩灯控制引脚</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">255</span>; j += <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; LEDS_COUNT; i++) &#123;</span><br><span class="line">      strip.setLedColorData(i, strip.Wheel((i * <span class="number">256</span> / LEDS_COUNT + j) &amp; <span class="number">255</span>));<span class="comment">//设置彩灯颜色数据</span></span><br><span class="line">    &#125;</span><br><span class="line">    strip.show();<span class="comment">//显示颜色</span></span><br><span class="line">    delay(<span class="number">5</span>);</span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="WIFI连接服务器获取数据"><a href="#WIFI连接服务器获取数据" class="headerlink" title="WIFI连接服务器获取数据"></a>WIFI连接服务器获取数据</h3><p>此处示例为使用STA模式连接WIFI并发起TCP连接获取数据，然后读取其中的<code>r</code>和<code>d</code>作为分隔符的内容</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WiFi.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *ssid = <span class="string">&quot;xxx&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *password = <span class="string">&quot;xxx&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> IPAddress <span class="title function_">serverIP</span><span class="params">(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</span>;</span><br><span class="line"><span class="type">uint16_t</span> serverPort = <span class="number">23333</span>;</span><br><span class="line">WiFiClient client;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span>&#123;</span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line">  Serial.println();</span><br><span class="line">  WiFi.mode(WIFI_STA);</span><br><span class="line">  WiFi.setSleep(<span class="literal">false</span>);</span><br><span class="line">  WiFi.setHostname(<span class="string">&quot;esp32&quot;</span>);</span><br><span class="line">  WiFi.begin(ssid, password);</span><br><span class="line">  <span class="keyword">while</span> (WiFi.status() != WL_CONNECTED)&#123;</span><br><span class="line">    delay(<span class="number">2000</span>);</span><br><span class="line">    Serial.print(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  Serial.println(<span class="string">&quot;WiFi connected, IP address: &quot;</span>);</span><br><span class="line">  Serial.println(WiFi.localIP());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span>&#123;</span><br><span class="line">  Serial.println(<span class="string">&quot;connecting to server&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (client.connect(serverIP, serverPort))&#123;</span><br><span class="line">    Serial.println(<span class="string">&quot;connected&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> (client.connected() || client.available())&#123;</span><br><span class="line">      <span class="keyword">if</span> (client.available())&#123;</span><br><span class="line">        String d = client.readStringUntil(<span class="string">&#x27;d&#x27;</span>);</span><br><span class="line">        Serial.println(d);</span><br><span class="line">        dir = d.toInt();</span><br><span class="line">        String r = client.readStringUntil(<span class="string">&#x27;r&#x27;</span>);</span><br><span class="line">        run = r.toInt();</span><br><span class="line">        Serial.println(r);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    Serial.println(<span class="string">&quot;err&quot;</span>);</span><br><span class="line">    client.stop();</span><br><span class="line">  &#125;</span><br><span class="line">  delay(<span class="number">5000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="蓝牙键盘"><a href="#蓝牙键盘" class="headerlink" title="蓝牙键盘"></a>蓝牙键盘</h3><p>D12引脚拉低则蓝牙键盘输出<code>HELLO</code>。问题在于如果esp32重启，必须重新配对才能让蓝牙键盘继续工作，还不知道原因，网上也没有搜到类似现象，也许是我esp32板子的问题？等我再换一个板子试一试。好了问题解决，github直接下载的<code>0.3</code>版本的<code>ESP32-BLE-Keyboard</code>库有bug，已经有人提出了<a target="_blank" rel="noopener" href="https://github.com/T-vK/ESP32-BLE-Keyboard/issues/166">issue</a>，在<code>0.3.2</code>中已经解决了这个问题，不过<code>0.3.2</code>还是Pre-release。下载这个库时候记得看版本要<code>0.3.2</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;BleKeyboard.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> previousMillis = <span class="number">0</span>;</span><br><span class="line">BleKeyboard <span class="title function_">bleKeyboard</span><span class="params">(<span class="string">&quot;ESP32&quot;</span>,<span class="string">&quot;triority&quot;</span>,<span class="number">100</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span>&#123;</span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line">  pinMode(<span class="number">12</span>, INPUT|PULLUP );</span><br><span class="line">  attachInterrupt(<span class="number">12</span>, blink, FALLING);</span><br><span class="line">  bleKeyboard.begin();</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">blink</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="type">int</span> ding = <span class="number">1</span>;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> currentMillis = millis();</span><br><span class="line">  <span class="keyword">if</span> (currentMillis - previousMillis &gt; <span class="number">80</span>)&#123;</span><br><span class="line">    <span class="keyword">while</span>(millis() - currentMillis &lt; <span class="number">30</span>)&#123;</span><br><span class="line">      <span class="keyword">if</span> (digitalRead(<span class="number">12</span>)==<span class="number">1</span>)&#123;</span><br><span class="line">        ding = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(ding)&#123;</span><br><span class="line">      previousMillis = currentMillis;</span><br><span class="line">      Serial.println(<span class="string">&quot;interrupt&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span>(bleKeyboard.isConnected())&#123;</span><br><span class="line">        bleKeyboard.print(<span class="string">&quot;HELLO&quot;</span>);</span><br><span class="line">        Serial.println(<span class="string">&quot;HELLO&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ESP32-NOW：一对一单向通信"><a href="#ESP32-NOW：一对一单向通信" class="headerlink" title="ESP32 NOW：一对一单向通信"></a>ESP32 NOW：一对一单向通信</h3><p>这部分内容来自<a target="_blank" rel="noopener" href="https://lingshunlab.com/book/esp32/esp32-now-introduce-and-one-way-communication">lingshunlab</a></p>
<h4 id="简介-7"><a href="#简介-7" class="headerlink" title="简介"></a>简介</h4><p>ESP-NOW 是乐鑫开发的一种无连接通信协议，沒有握手协议(CHAP)，具有短包传输的特点。该协议使多个设备能够在不使用Wi-Fi的情况下以简单的方式进行相互通讯，类似于低功耗 2.4GHz 无线连接，设备之间的配对是在它们通信之前就需要配对好在代码中。配对完成后，连接是安全的，持久的，点对点的。换句话说，如果你的一块ESP32板突然断电或重置，当它重新启动时，它就会自动连接到它的已经提前配对好的网路中以继续通信。</p>
<h4 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h4><p>在有限的加密对等点：</p>
<ul>
<li>Station模式最多支持10个设备的加密对等点网络通讯；</li>
<li>SoftAP或SoftAP+Station模式下最多支持6个设备；</li>
</ul>
<p>多个未加密对等点：</p>
<ul>
<li>其总数应少于 20 个设备</li>
<li>有效载荷限制为 250 字节。</li>
</ul>
<p>2个ESP32开发板在空旷区域中进行单向通讯，相隔30米仍然能很好低接收信息。</p>
<h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><h5 id="发送端-slave-x2F-sender"><a href="#发送端-slave-x2F-sender" class="headerlink" title="发送端(slave&#x2F;sender)"></a>发送端(slave&#x2F;sender)</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 加载需要的库 </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;esp_now.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WiFi.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义接收端的mac地址,这里的地址请替换成接收端ESP32的MAC地址</span></span><br><span class="line"><span class="type">uint8_t</span> broadcastAddress[] = &#123;<span class="number">0xFF</span>, <span class="number">0xFF</span>, <span class="number">0xFF</span>, <span class="number">0xFF</span>, <span class="number">0xFF</span>, <span class="number">0xFF</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送数据的结构示例</span></span><br><span class="line"><span class="comment">// 在C中使用 typedef struct 定义一个结构体类型,名为struct_message</span></span><br><span class="line"><span class="comment">// 必须与接收方的结构相匹配一致</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">struct_message</span> &#123;</span></span><br><span class="line">  <span class="type">char</span> a[<span class="number">40</span>];</span><br><span class="line">  <span class="type">int</span> b;</span><br><span class="line">  <span class="type">float</span> c;</span><br><span class="line">  <span class="type">bool</span> d;</span><br><span class="line">&#125; struct_message;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建 结构为struct_message的myData变量</span></span><br><span class="line">struct_message myData;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 声明对等网络信息实体类变量</span></span><br><span class="line"><span class="type">esp_now_peer_info_t</span> peerInfo;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当发送信息时，触发的回调函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">OnDataSent</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *mac_addr, <span class="type">esp_now_send_status_t</span> status)</span> &#123;</span><br><span class="line">  Serial.print(<span class="string">&quot;\r\nLast Packet Send Status:\t&quot;</span>);</span><br><span class="line">  Serial.println(status == ESP_NOW_SEND_SUCCESS ? <span class="string">&quot;Delivery Success&quot;</span> : <span class="string">&quot;Delivery Fail&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">// 设置串口波特率</span></span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置设备WIFI模式为WIFI_STA</span></span><br><span class="line">  WiFi.mode(WIFI_STA);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化ESPNOW</span></span><br><span class="line">  <span class="keyword">if</span> (esp_now_init() != ESP_OK) &#123;</span><br><span class="line">    Serial.println(<span class="string">&quot;Error initializing ESP-NOW&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 当ESPNOW初始化成功,我们将会注册一个回调函数(callback，CB)</span></span><br><span class="line">  <span class="comment">// 获得数据包的发送情况</span></span><br><span class="line">  esp_now_register_send_cb(OnDataSent);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 配置对等(对等点)网络</span></span><br><span class="line">  <span class="built_in">memcpy</span>(peerInfo.peer_addr, broadcastAddress, <span class="number">6</span>);</span><br><span class="line">  peerInfo.channel = <span class="number">0</span>;  </span><br><span class="line">  peerInfo.encrypt = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加对等(对等点)网络       </span></span><br><span class="line">  <span class="keyword">if</span> (esp_now_add_peer(&amp;peerInfo) != ESP_OK)&#123;</span><br><span class="line">    Serial.println(<span class="string">&quot;Failed to add peer&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">// 赋值需要发送的变量数据 </span></span><br><span class="line">  <span class="built_in">strcpy</span>(myData.a, <span class="string">&quot;Welcome to Lingshunlab.com&quot;</span>);</span><br><span class="line">  myData.b = random(<span class="number">1</span>,<span class="number">20</span>);</span><br><span class="line">  myData.c = <span class="number">1.2</span>;</span><br><span class="line">  myData.d = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 通过ESPNOW发送信息</span></span><br><span class="line">  <span class="type">esp_err_t</span> result = esp_now_send(broadcastAddress, (<span class="type">uint8_t</span> *) &amp;myData, <span class="keyword">sizeof</span>(myData));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 根据 result 返回结果判断是否发送成功</span></span><br><span class="line">  <span class="keyword">if</span> (result == ESP_OK) &#123;<span class="comment">// 当 发送成功 时</span></span><br><span class="line">    Serial.println(<span class="string">&quot;Sent with success&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123; <span class="comment">// 当 发送失败 时</span></span><br><span class="line">    Serial.println(<span class="string">&quot;Error sending the data&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  delay(<span class="number">2000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="ESPNOW接收端"><a href="#ESPNOW接收端" class="headerlink" title="ESPNOW接收端"></a>ESPNOW接收端</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 加载需要的库 </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;esp_now.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WiFi.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 接收数据的结构示例</span></span><br><span class="line"><span class="comment">// 在C中使用 typedef struct 定义一个结构体类型,名为struct_message</span></span><br><span class="line"><span class="comment">// 必须与发送方的结构相匹配一致</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">struct_message</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> a[<span class="number">40</span>];</span><br><span class="line">    <span class="type">int</span> b;</span><br><span class="line">    <span class="type">float</span> c;</span><br><span class="line">    <span class="type">bool</span> d;</span><br><span class="line">&#125; struct_message;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建 结构为struct_message的myData变量</span></span><br><span class="line">struct_message myData;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当收到数据时将执行的回调函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">OnDataRecv</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> * mac, <span class="type">const</span> <span class="type">uint8_t</span> *incomingData, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;myData, incomingData, <span class="keyword">sizeof</span>(myData));</span><br><span class="line">  Serial.print(<span class="string">&quot;Bytes received: &quot;</span>);</span><br><span class="line">  Serial.println(len);</span><br><span class="line">  Serial.print(<span class="string">&quot;Char: &quot;</span>);</span><br><span class="line">  Serial.println(myData.a);</span><br><span class="line">  Serial.print(<span class="string">&quot;Int: &quot;</span>);</span><br><span class="line">  Serial.println(myData.b);</span><br><span class="line">  Serial.print(<span class="string">&quot;Float: &quot;</span>);</span><br><span class="line">  Serial.println(myData.c);</span><br><span class="line">  Serial.print(<span class="string">&quot;Bool: &quot;</span>);</span><br><span class="line">  Serial.println(myData.d);</span><br><span class="line">  Serial.println();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">// 设置串口波特率</span></span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置设备WIFI模式为WIFI_STA</span></span><br><span class="line">  WiFi.mode(WIFI_STA);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化ESPNOW</span></span><br><span class="line">  <span class="keyword">if</span> (esp_now_init() != ESP_OK) &#123;</span><br><span class="line">    Serial.println(<span class="string">&quot;Error initializing ESP-NOW&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 当ESPNOW初始化成功,我们将会注册一个回调函数(callback，CB)</span></span><br><span class="line">  <span class="comment">// 获得回收的包装信息</span></span><br><span class="line">  esp_now_register_recv_cb(OnDataRecv);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="EEPROM：断电数据保存"><a href="#EEPROM：断电数据保存" class="headerlink" title="EEPROM：断电数据保存"></a>EEPROM：断电数据保存</h3><p>EEPROM (electrically erasable programmable read-only memory)是一种用户可修改的ROM，又或者称为闪存(Flash Memory)。是一种非易失性ROM，可以擦除和重新编程单个字节的数据。这就是 EEPROM芯片被称为字节可擦除芯片的原因。EEPROM 通常用于在计算和其他电子设备中存储少量数据。</p>
<p>EEPROM里面的数据是可以断电保存的，重新上电数据并不会丢失。但是，闪存的一个限制是可刷写数据的次数。你可以根据需要多次从闪存中读取数据，但大多数设备闪存的写入次数设计为大约 100,000 到 1,000,000 次写入操作。</p>
<blockquote>
<p>Arduino Uno 的EEEROM大小为1024个字节。<br>ESP32的EEPROM大小为 512 字节。<br>这意味着使用 ESP32 和 EEPROM 库可以有 512 个不同的地址，可以在每个地址位置保存一个 0 到 255 之间的值。</p>
</blockquote>
<p>在 ESP32 的闪存读取和写入将使用 EEPROM 库。其实是和 Arduino EEPROM 一样的，并没有太大区别。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 加载EEPROM的库</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;EEPROM.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义EEPROM的大小</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EEPROM_SIZE 1  <span class="comment">// 这里定义1个字节的大小</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> read_value = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123; </span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化EEPROM为预定义的大小</span></span><br><span class="line">  EEPROM.begin(EEPROM_SIZE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  read_value = EEPROM.read(<span class="number">0</span>); <span class="comment">// 读EEPROM第0位的数据</span></span><br><span class="line">  Serial.println(read_value);  </span><br><span class="line"></span><br><span class="line">  read_value++;   <span class="comment">// read_value+1 ，EEPROM只接受0～255的数值，超出的将会是255的取余值</span></span><br><span class="line">  EEPROM.write(<span class="number">0</span>, read_value); <span class="comment">// 把变量read_value的数值写入第0位</span></span><br><span class="line">  EEPROM.commit(); <span class="comment">// 需要提交才能正真地把数据写入EEPROM</span></span><br><span class="line"></span><br><span class="line">  delay(<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="低功耗"><a href="#低功耗" class="headerlink" title="低功耗"></a>低功耗</h3><h4 id="低功耗模式"><a href="#低功耗模式" class="headerlink" title="低功耗模式"></a>低功耗模式</h4><p><img src="/2023/esp32-all-in-one/esp32%E5%8A%9F%E8%80%97.png" alt="各种低功耗模式电流"></p>
<p><img src="/2023/esp32-all-in-one/2020061714483194.png" alt="三种模式的区别"></p>
<ul>
<li><code>Modem-sleep</code> 模式：CPU 可运行，时钟可被配置。Wi-Fi&#x2F;蓝牙基带和射频关闭</li>
<li><code>Light-sleep</code> 模式：CPU 暂停运行，Wi-Fi&#x2F;蓝牙基带和射频关闭。RTC 存储器和外设以及 ULP 协处理器运行。任何唤醒事件(MAC、主机、RTC 定时器或外部中断)都会唤醒芯片</li>
<li><code>Deep-sleep</code> 模式：CPU 和大部分外设都会掉电，Wi-Fi&#x2F;蓝牙基带和射频关闭，只有 RTC 存储器和 RTC 外设以及 ULP 协处理器可以工作。Wi-Fi 和蓝牙连接数据存储在 RTC 中</li>
</ul>
<h4 id="Modem-sleep"><a href="#Modem-sleep" class="headerlink" title="Modem-sleep"></a>Modem-sleep</h4><p>目前 ESP32 的<code>Modem-sleep</code>仅工作在<code>Station</code>模式下,连接路由器后生效。<code>Station</code>会周期性在工作状态和睡眠状态两者之间切换。<br>ESP32通过Wi-Fi的<code>DTIM Beacon</code>机制与路由器保持连接。在<code>Modem-sleep</code>模式下，系统可以自动被唤醒，无需配置唤醒源</p>
<p>在 <code>Modem-sleep</code> 模式下，ESP32 会在两次 <code>DTIM Beacon</code> 间隔时间内，关闭 Wi-Fi 模块电路，达到省电效果，在下次 <code>Beacon</code> 到来前自动唤醒。睡眠时间由路由器的 <code>DTIM Beacon</code> 时间决定。<code>Modem-sleep</code> 模式可以保持与路由器的 Wi-Fi 连接，并通过路由器接收来自手机或者服务器的交互信息</p>
<p><code>Modem-sleep</code> 一般用于 CPU 持续处于工作状态并需要保持 Wi-Fi 连接的应用场景，例如，使用 ESP32 本地语音唤醒功能，CPU 需要持续采集和处理音频数据。</p>
<blockquote>
<p>一般路由器的 DTIM Beacon 间隔为 100 ms ~ 1,000 ms</p>
</blockquote>
<h4 id="Light-sleep"><a href="#Light-sleep" class="headerlink" title="Light-sleep"></a>Light-sleep</h4><p><code>Light-sleep</code>的工作模式与<code>Modem-sleep</code>相似，不同的是，除了关闭 Wi-Fi 模块电路以外，在 <code>Light-sleep</code> 模式下，还会关闭时钟并暂停内部 CPU，比<code>Modem-sleep</code>功耗更低。有两种方式使 CPU 进入<code>Light-sleep</code>模式：</p>
<ul>
<li>强制<code>Light-sleep</code>： 通过调用 API 强制 CPU 进入 <code>Light-sleep</code> 模式，强制进入 <code>Light-sleep</code> 模式后，不能通过路由器接收来自手机或者服务器的交互信息。强制关闭 Wi-Fi 模块电路并暂停内部 CPU。能通过定时器、 GPIO（RTC IO 和 Digital IO）和 UART 唤醒。从 <code>Light-sleep</code> 唤醒后，会从进入休眠的位置继续执行程序。</li>
<li>自动<code>Light-sleep</code>： 配置为自动休眠方式后，会在 CPU 处于空闲的状态下自动进入<code>Light-sleep</code>模式，能通过路由器接收来自手机或者服务器的交互信息。通常自动<code>Light-sleep</code>会与<code>Modem-sleep</code> 模式以及电源管理功能共同使用，电源管理功能允许系统根据 CPU 负载动态调节 CPU 频率以降低功耗。比如 Wi-Fi 开关的应用，大部分时间 CPU 都是空闲的，直到收到控制命令，CPU 才需要进行 GPIO 的操作。</li>
</ul>
<blockquote>
<p>强制 Light-sleep 接口调用后，并不会立即休眠，而是等到系统空闲后才进入休眠</p>
</blockquote>
<blockquote>
<p>若系统应用中有小于 DTIM Beacon 间隔时间的循环定时,系统将不能进入 Light-sleep 模式</p>
</blockquote>
<h4 id="Deep-sleep"><a href="#Deep-sleep" class="headerlink" title="Deep-sleep"></a>Deep-sleep</h4><p>相对于其他两种模式，系统无法自动进入<code>Deep-sleep</code>，需要由用户调用接口函数<code>esp_deep_sleep_start()</code>进入<code>Deep-sleep</code>模式。在该模式下，芯片会断开所有 Wi-Fi 连接与数据连接，进入<code>Deep-sleep</code>模式，只有 RTC 存储器和 RTC 外设以及 ULP 协处理器可以工作。从<code>Deep-sleep</code>唤醒后，CPU 将软件复位重启</p>
<p><code>Deep-sleep</code>可以用于低功耗的传感器应用,或者大部分时间都不需要进行数据传输的情况。设备可以每隔一段时间从<code>Deep-sleep</code>状态醒来测量数据并上传,之后继续进入<code>Deep-sleep</code>。也可以将多个数据存储于<code>RTC memory</code>(<code>RTC memory</code>在<code>Deep-sleep</code>模式下仍然可以保存数据),然后一次发送出去</p>
<h5 id="定时唤醒：6uA左右"><a href="#定时唤醒：6uA左右" class="headerlink" title="定时唤醒：6uA左右"></a>定时唤醒：6uA左右</h5><p>这是官方提供的示例代码，已经把注释改成了中文。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> uS_TO_S_FACTOR 1000000ULL  <span class="comment">//微秒到秒的转换</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TIME_TO_SLEEP  5        <span class="comment">//进入休眠模式时间</span></span></span><br><span class="line">RTC_DATA_ATTR <span class="type">int</span> bootCount = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//打印被唤醒原因的方法</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_wakeup_reason</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="type">esp_sleep_wakeup_cause_t</span> wakeup_reason;</span><br><span class="line">  wakeup_reason = esp_sleep_get_wakeup_cause();</span><br><span class="line">  <span class="keyword">switch</span>(wakeup_reason)&#123;</span><br><span class="line">    <span class="keyword">case</span> ESP_SLEEP_WAKEUP_EXT0 : Serial.println(<span class="string">&quot;Wakeup caused by external signal using RTC_IO&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ESP_SLEEP_WAKEUP_EXT1 : Serial.println(<span class="string">&quot;Wakeup caused by external signal using RTC_CNTL&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ESP_SLEEP_WAKEUP_TIMER : Serial.println(<span class="string">&quot;Wakeup caused by timer&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ESP_SLEEP_WAKEUP_TOUCHPAD : Serial.println(<span class="string">&quot;Wakeup caused by touchpad&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ESP_SLEEP_WAKEUP_ULP : Serial.println(<span class="string">&quot;Wakeup caused by ULP program&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span> : Serial.<span class="built_in">printf</span>(<span class="string">&quot;Wakeup was not caused by deep sleep: %d\n&quot;</span>,wakeup_reason); <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span>&#123;</span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line">  delay(<span class="number">1000</span>);</span><br><span class="line">  ++bootCount;</span><br><span class="line">  Serial.println(<span class="string">&quot;Boot number: &quot;</span> + String(bootCount));</span><br><span class="line">  </span><br><span class="line">  print_wakeup_reason();</span><br><span class="line">  <span class="comment">//配置唤醒源，每五秒唤醒一次，在没有提供唤醒源的情况下睡眠，除非硬件重置，它将永远休眠</span></span><br><span class="line">  esp_sleep_enable_timer_wakeup(TIME_TO_SLEEP * uS_TO_S_FACTOR);</span><br><span class="line">  Serial.println(<span class="string">&quot;Setup ESP32 to sleep for every &quot;</span> + String(TIME_TO_SLEEP) + <span class="string">&quot; Seconds&quot;</span>);</span><br><span class="line">  Serial.println(<span class="string">&quot;Going to sleep now&quot;</span>);</span><br><span class="line">  Serial.flush(); </span><br><span class="line">  <span class="comment">//开始进入休眠</span></span><br><span class="line">  esp_deep_sleep_start();</span><br><span class="line">  Serial.println(<span class="string">&quot;This will never be printed&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Touchpad唤醒：36uA左右"><a href="#Touchpad唤醒：36uA左右" class="headerlink" title="Touchpad唤醒：36uA左右"></a>Touchpad唤醒：36uA左右</h5><p>调用<code>esp_deep_sleep_enable_touchpad_wakeup()</code>函数使能<code>touchpad</code>唤醒，然后调用<code>esp_deep_sleep_start()</code>函数进入<code>Deep-sleep</code>模式</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">此代码展示深度睡眠以触摸作为唤醒源以及如何存储数据，RTC内存在重新启动时使用</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">ESP32 可以启用多个触摸作为唤醒源</span></span><br><span class="line"><span class="comment">ESP32-S2 和 ESP32-S3 仅支持 1 个触摸作为唤醒源启用</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> CONFIG_IDF_TARGET_ESP32</span></span><br><span class="line">  <span class="meta">#<span class="keyword">define</span> THRESHOLD   40      <span class="comment">//值越大，灵敏度越高</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span> <span class="comment">//ESP32-S2 和 ESP32-S3</span></span></span><br><span class="line">  <span class="meta">#<span class="keyword">define</span> THRESHOLD   5000   <span class="comment">//值越低，灵敏度越高</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">RTC_DATA_ATTR <span class="type">int</span> bootCount = <span class="number">0</span>;</span><br><span class="line"><span class="type">touch_pad_t</span> touchPin;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_wakeup_reason</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="type">esp_sleep_wakeup_cause_t</span> wakeup_reason;</span><br><span class="line">  wakeup_reason = esp_sleep_get_wakeup_cause();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span>(wakeup_reason)&#123;</span><br><span class="line">    <span class="keyword">case</span> ESP_SLEEP_WAKEUP_EXT0 : Serial.println(<span class="string">&quot;Wakeup caused by external signal using RTC_IO&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ESP_SLEEP_WAKEUP_EXT1 : Serial.println(<span class="string">&quot;Wakeup caused by external signal using RTC_CNTL&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ESP_SLEEP_WAKEUP_TIMER : Serial.println(<span class="string">&quot;Wakeup caused by timer&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ESP_SLEEP_WAKEUP_TOUCHPAD : Serial.println(<span class="string">&quot;Wakeup caused by touchpad&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ESP_SLEEP_WAKEUP_ULP : Serial.println(<span class="string">&quot;Wakeup caused by ULP program&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span> : Serial.<span class="built_in">printf</span>(<span class="string">&quot;Wakeup was not caused by deep sleep: %d\n&quot;</span>,wakeup_reason); <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_wakeup_touchpad</span><span class="params">()</span>&#123;</span><br><span class="line">  touchPin = esp_sleep_get_touchpad_wakeup_status();</span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="keyword">if</span> CONFIG_IDF_TARGET_ESP32</span></span><br><span class="line">    <span class="keyword">switch</span>(touchPin)&#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0</span>  : Serial.println(<span class="string">&quot;Touch detected on GPIO 4&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>  : Serial.println(<span class="string">&quot;Touch detected on GPIO 0&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>  : Serial.println(<span class="string">&quot;Touch detected on GPIO 2&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>  : Serial.println(<span class="string">&quot;Touch detected on GPIO 15&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4</span>  : Serial.println(<span class="string">&quot;Touch detected on GPIO 13&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5</span>  : Serial.println(<span class="string">&quot;Touch detected on GPIO 12&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">6</span>  : Serial.println(<span class="string">&quot;Touch detected on GPIO 14&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">7</span>  : Serial.println(<span class="string">&quot;Touch detected on GPIO 27&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">8</span>  : Serial.println(<span class="string">&quot;Touch detected on GPIO 33&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">9</span>  : Serial.println(<span class="string">&quot;Touch detected on GPIO 32&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span> : Serial.println(<span class="string">&quot;Wakeup not by touchpad&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="keyword">if</span>(touchPin &lt; TOUCH_PAD_MAX)&#123;</span><br><span class="line">      Serial.<span class="built_in">printf</span>(<span class="string">&quot;Touch detected on GPIO %d\n&quot;</span>, touchPin); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">      Serial.println(<span class="string">&quot;Wakeup not by touchpad&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span>&#123;</span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line">  delay(<span class="number">1000</span>);</span><br><span class="line">  ++bootCount;</span><br><span class="line">  Serial.println(<span class="string">&quot;Boot number: &quot;</span> + String(bootCount));</span><br><span class="line"></span><br><span class="line">  <span class="comment">//打印唤醒原因和触摸引脚</span></span><br><span class="line">  print_wakeup_reason();</span><br><span class="line">  print_wakeup_touchpad();</span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="keyword">if</span> CONFIG_IDF_TARGET_ESP32 </span></span><br><span class="line">  <span class="comment">//设置唤醒引脚为 GPIO15 + GPIO 27</span></span><br><span class="line">  touchSleepWakeUpEnable(T3,THRESHOLD);</span><br><span class="line">  touchSleepWakeUpEnable(T7,THRESHOLD);</span><br><span class="line">  </span><br><span class="line">  <span class="meta">#<span class="keyword">else</span> <span class="comment">//ESP32-S2 + ESP32-S3</span></span></span><br><span class="line">  <span class="comment">//设置唤醒引脚为 GPIO3</span></span><br><span class="line">  touchSleepWakeUpEnable(T3,THRESHOLD);</span><br><span class="line">  <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//进入睡眠模式</span></span><br><span class="line">  Serial.println(<span class="string">&quot;Going to sleep now&quot;</span>);</span><br><span class="line">  esp_deep_sleep_start();</span><br><span class="line">  Serial.println(<span class="string">&quot;This will never be printed&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<h5 id="GPIO唤醒：6uA左右"><a href="#GPIO唤醒：6uA左右" class="headerlink" title="GPIO唤醒：6uA左右"></a>GPIO唤醒：6uA左右</h5><ul>
<li><code>External wakeup</code> (ext0)</li>
</ul>
<p><code>RTC IO</code>模块包含当其中一个<code>RTC IO</code>的电平为唤醒电平（可配置为逻辑高或低）触发唤醒的逻辑。<br><code>RTC IO</code>是 RTC 外设电源域的一部分，因此如果使能该唤醒源，RTC 外设将在睡眠期间保持上电状态。在 ESP32 的修订版 0 和 1 中，此唤醒源与 ULP 和触摸唤醒源不兼容。</p>
<p>由于在此模式下启用了<code>RTC IO</code>模块，因此也可以使用内部上拉或下拉电阻。<br><code>esp_sleep_enable_ext0_wakeup()</code>函数可用于启用此唤醒源。</p>
<ul>
<li><code>External wakeup</code> (ext1)</li>
</ul>
<p>RTC 控制器包含使用 多个 RTC IO 触发唤醒的逻辑。两个逻辑功能之一可用于触发唤醒：<br>如果任何一个所选 IO 为高电平，则唤醒（<code>ESP_EXT1_WAKEUP_ANY_HIGH</code>）<br>如果所有选定的 IO 都为低电平，则唤醒（<code>ESP_EXT1_WAKEUP_ALL_LOW</code>）<br>该唤醒源由 RTC 控制器实现。因此，RTC 外设和 RTC 存储器可以在此模式下断电。</p>
<p>但是，如果 RTC 外设断电，内部上拉和下拉电阻将被禁用。要使用内部上拉或下拉电阻，请在睡眠期间请求 RTC 外设电源域保持上电。<code>esp_sleep_enable_ext1_wakeup()</code>函数可用于启用此唤醒源。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">此代码展示如何将深度睡眠与作为唤醒源的外部触发器，以及如何将数据存储在 RTC 内存中，以便在重新启动时使用它</span></span><br><span class="line"><span class="comment">按下 GPIO 33 按钮以 10K 欧姆向下拉</span></span><br><span class="line"><span class="comment">注意，只有 RTC IO 可以用作外部唤醒的源。它们是引脚：0，2，4，12-15，25-27，32-39。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUTTON_PIN_BITMASK 0x200000000 <span class="comment">// 2^33 in hex</span></span></span><br><span class="line">RTC_DATA_ATTR <span class="type">int</span> bootCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_wakeup_reason</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="type">esp_sleep_wakeup_cause_t</span> wakeup_reason;</span><br><span class="line">  wakeup_reason = esp_sleep_get_wakeup_cause();</span><br><span class="line">  <span class="keyword">switch</span>(wakeup_reason)&#123;</span><br><span class="line">    <span class="keyword">case</span> ESP_SLEEP_WAKEUP_EXT0 : Serial.println(<span class="string">&quot;Wakeup caused by external signal using RTC_IO&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ESP_SLEEP_WAKEUP_EXT1 : Serial.println(<span class="string">&quot;Wakeup caused by external signal using RTC_CNTL&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ESP_SLEEP_WAKEUP_TIMER : Serial.println(<span class="string">&quot;Wakeup caused by timer&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ESP_SLEEP_WAKEUP_TOUCHPAD : Serial.println(<span class="string">&quot;Wakeup caused by touchpad&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ESP_SLEEP_WAKEUP_ULP : Serial.println(<span class="string">&quot;Wakeup caused by ULP program&quot;</span>); <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span> : Serial.<span class="built_in">printf</span>(<span class="string">&quot;Wakeup was not caused by deep sleep: %d\n&quot;</span>,wakeup_reason); <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span>&#123;</span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line">  delay(<span class="number">1000</span>);</span><br><span class="line">  ++bootCount;</span><br><span class="line">  Serial.println(<span class="string">&quot;Boot number: &quot;</span> + String(bootCount));</span><br><span class="line">  print_wakeup_reason();</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  首先，我们将 ESP32 设置为外部唤醒触发器。ESP32 有两种类型，ext0 和 ext1。</span></span><br><span class="line"><span class="comment">  ext0 使用RTC_IO唤醒，因此需要 RTC 外设</span></span><br><span class="line"><span class="comment">  ext1 在使用 RTC 控制器时打开，所以不需要打开电源的外围设备。</span></span><br><span class="line"><span class="comment">  请注意，使用内部上拉/下拉还需要打开 RTC 外围设备。</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  esp_sleep_enable_ext0_wakeup(GPIO_NUM_33,<span class="number">1</span>);</span><br><span class="line">  <span class="comment">//如果你使用 ext1：esp_sleep_enable_ext1_wakeup(BUTTON_PIN_BITMASK,ESP_EXT1_WAKEUP_ANY_HIGH);</span></span><br><span class="line">  Serial.println(<span class="string">&quot;Going to sleep now&quot;</span>);</span><br><span class="line">  esp_deep_sleep_start();</span><br><span class="line">  Serial.println(<span class="string">&quot;This will never be printed&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="web服务器"><a href="#web服务器" class="headerlink" title="web服务器"></a>web服务器</h3><p>连接wifi后，浏览器输入串口输出的ip，打开网页就会让led灯亮起一秒。考虑到学弟喜欢写脚本疯狂访问来让继电器输出PWM，加了个10s的延时不接受新的连接。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WiFi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WebServer.h&gt;</span></span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* ssid = <span class="string">&quot;xxx&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* password = <span class="string">&quot;xxx&quot;</span>;</span><br><span class="line"><span class="type">int</span> led0=<span class="number">13</span>;</span><br><span class="line">WebServer <span class="title function_">server</span><span class="params">(<span class="number">80</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">handleRoot</span><span class="params">()</span>&#123;</span><br><span class="line">  String HTML = <span class="string">&quot;&lt;!DOCTYPE html&gt;\</span></span><br><span class="line"><span class="string">  &lt;html&gt;&lt;head&gt;&lt;meta charset=&#x27;utf-8&#x27;&gt;&lt;/head&gt;\</span></span><br><span class="line"><span class="string">  &lt;body&gt;没错,这就是ESP32网页!\</span></span><br><span class="line"><span class="string">  &lt;/body&gt;&lt;/html&gt;&quot;</span>;</span><br><span class="line">  digitalWrite(led0, <span class="number">0</span>);</span><br><span class="line">  server.send(<span class="number">200</span>, <span class="string">&quot;text/html&quot;</span>, HTML);</span><br><span class="line">  delay(<span class="number">3000</span>);</span><br><span class="line">  digitalWrite(led0, <span class="number">1</span>);</span><br><span class="line">  delay(<span class="number">10000</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span>&#123;</span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line">  pinMode(led0, OUTPUT);</span><br><span class="line">  digitalWrite(led0, <span class="number">1</span>);</span><br><span class="line">  WiFi.mode(WIFI_STA);</span><br><span class="line">  WiFi.begin(ssid, password);</span><br><span class="line">  Serial.println(<span class="string">&quot;开始连接WIFI&quot;</span>);</span><br><span class="line">  <span class="keyword">while</span> (WiFi.status() != WL_CONNECTED)&#123;</span><br><span class="line">    Serial.print(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">    delay(<span class="number">100</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  Serial.print(<span class="string">&quot;\nIP位址:&quot;</span>);</span><br><span class="line">  Serial.println(WiFi.localIP());</span><br><span class="line">  server.on(<span class="string">&quot;/&quot;</span>, handleRoot);</span><br><span class="line">  server.onNotFound([]()&#123;</span><br><span class="line">    server.send(<span class="number">404</span>, <span class="string">&quot;text/plain&quot;</span>, <span class="string">&quot;File NOT found!&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  server.begin();</span><br><span class="line">  Serial.println(<span class="string">&quot;启动成功&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  server.handleClient();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ota升级"><a href="#ota升级" class="headerlink" title="ota升级"></a>ota升级</h3><p>在Arduino IDE中选择<code>File&gt;Example&gt;ArduinoOTA&gt;OTAWebUpdate</code>例子程序。在程序中更改成自己的WiFi名字和密码。</p>
<p>上载程序后打开串口监视器，按ESP32板子的复位重启按钮，通过串口监视器可以看到这个ESP32服务器的地址</p>
<p>输入ESP32 IP地址，可以在浏览器中输入用户名和密码，点击login。</p>
<p>用<code>Sketch&gt;Export compiled Binary</code>。这时在sketch中创建一个.bin的文件。现在，在OTA的web page中选择文件，‘Choose File’ 按钮，选择.bin文件。点击Update按钮。开始上载程序</p>
<p>实操程序无法运行，未找到原因找到再来写，不过话说这个好似是一次性的，也就没太大用</p>
<h3 id="多核操作"><a href="#多核操作" class="headerlink" title="多核操作"></a>多核操作</h3><p>ESP32具有两个32位<code>Tensilica Xtensa LX6</code>微处理器，这使其成为功能强大的双核（core0和core1）微控制器。有单核和双核两种版本。但是双核版本更受欢迎，因为它们之间没有明显的价格差异。</p>
<p>一般使用Arduino IDE进行编程时，由于<code>Core0</code>已编程用于RF通信，因此代码仅在<code>Core1</code>上运行。我们将展示如何使用ESP32的两个内核同时执行两项操作</p>
<p>ESP32开发板已经安装了<code>FreeRTOS</code>固件。 <code>FreeRTOS</code>是开源的实时操作系统，在多任务处理中非常有用。 RTOS有助于管理资源并最大程度地提高系统性能。 <code>FreeRTOS</code>具有许多用于不同目的的API函数，使用这些API，我们可以创建任务并使它们运行在不同的内核上。</p>
<p><a target="_blank" rel="noopener" href="https://www.freertos.org/Documentation/161204_Mastering_the_FreeRTOS_Real_Time_Kernel-A_Hands-On_Tutorial_Guide.pdf">FreeRTOS API的完整文档</a></p>
<h4 id="查找ESP32内核ID"><a href="#查找ESP32内核ID" class="headerlink" title="查找ESP32内核ID"></a>查找ESP32内核ID</h4><p>可以从void setup()和void loop()函数中调用此函数，以了解运行这些函数的内核ID</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xPortGetCoreID()</span><br></pre></td></tr></table></figure>

<p>测试一下这个程序：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span>&#123;</span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line">  Serial.print(<span class="string">&quot;setup() function running on core: &quot;</span>);</span><br><span class="line">  Serial.println(xPortGetCoreID());</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span>&#123;</span><br><span class="line">  Serial.print(<span class="string">&quot;loop() function running on core: &quot;</span>);</span><br><span class="line">  Serial.println(xPortGetCoreID());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>串口输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">16:19:10.291 -&gt; setup() function running on core: 1</span><br><span class="line">16:19:10.291 -&gt; loop() function running on core: 1</span><br><span class="line">16:19:10.291 -&gt; loop() function running on core: 1</span><br><span class="line">16:19:10.291 -&gt; loop() function running on core: 1</span><br></pre></td></tr></table></figure>
<h4 id="双核编程方法"><a href="#双核编程方法" class="headerlink" title="双核编程方法"></a>双核编程方法</h4><p>Arduino IDE支持在ESP32运行FreeRTOS，而FreeRTOS API允许我们创建可以在两个内核上独立运行的任务。<br>以下函数用于创建可以在两个内核上运行的任务。在此函数中，我们必须提供一些参数，例如优先级、内核ID等。</p>
<h5 id="创建任务"><a href="#创建任务" class="headerlink" title="创建任务"></a>创建任务</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xTaskCreatePinnedToCore()</span><br></pre></td></tr></table></figure>
<p>此函数使用7个参数：</p>
<ul>
<li>实现任务的函数名称：<code>task1</code></li>
<li>任务的任何名称：<code>task1</code></li>
<li>分配给任务的堆栈大小：以字为单位</li>
<li>任务输入参数：可以为NULL</li>
<li>任务的优先级：0是最低优先级</li>
<li>任务句柄：可以为NULL</li>
<li>任务将运行的内核ID：0或1</li>
</ul>
<p>举例：通过在xTaskCreatePinnedToCore()函数中提供所有参数来创建任务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xTaskCreatePinnedToCore(Task1code, &quot;Task1&quot;, 10000, NULL, 1, NULL,  0);</span><br></pre></td></tr></table></figure>
<h4 id="定义Taskcode函数"><a href="#定义Taskcode函数" class="headerlink" title="定义Taskcode函数"></a>定义Taskcode函数</h4><p>在<code>void setup()&#123;&#125;</code>函数之外，为任务创建单独的函数，这个函数将在<code>core0</code>上运行</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Void <span class="title function_">Task1code</span><span class="params">( <span class="type">void</span> * parameter)</span> &#123;</span><br><span class="line">  Serial.print(<span class="string">&quot;Task1 running on core &quot;</span>);</span><br><span class="line">  Serial.println(xPortGetCoreID());</span><br><span class="line">  <span class="keyword">for</span>(;;) &#123;<span class="comment">//infinite loop</span></span><br><span class="line">    digitalWrite(led, HIGH);</span><br><span class="line">    delay(<span class="number">500</span>);</span><br><span class="line">    digitalWrite(led, LOW);</span><br><span class="line">    ​​delay(<span class="number">500</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们已经知道<code>loop()</code>和<code>setup()</code>函数在<code>core1</code>上运行，因此可以在<code>void loop()</code>函数中实现core1任务</p>
<h4 id="喂狗"><a href="#喂狗" class="headerlink" title="喂狗"></a>喂狗</h4><p>需要注意一件事，如果把一个在<code>cpu0</code>持续执行的任务的优先级写的大于<code>0</code>，那么其他任务都将无法得到cpu0，比如<code>IDLE</code>，而这个任务默认开启5s的看门狗，这将导致单片机每五秒重置一次，串口输出如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">18:51:12.378 -&gt; E (10179) task_wdt: Task watchdog got triggered. The following tasks did not reset the watchdog in time:</span><br><span class="line">18:51:12.378 -&gt; E (10179) task_wdt:  - IDLE (CPU 0)</span><br><span class="line">18:51:12.378 -&gt; E (10179) task_wdt: Tasks currently running:</span><br><span class="line">18:51:12.378 -&gt; E (10179) task_wdt: CPU 0: Task1</span><br><span class="line">18:51:12.378 -&gt; E (10179) task_wdt: CPU 1: IDLE</span><br><span class="line">18:51:12.378 -&gt; E (10179) task_wdt: Aborting.</span><br><span class="line">18:51:12.378 -&gt;</span><br><span class="line">18:51:12.378 -&gt; abort() was called at PC 0x400df979 on core 0</span><br><span class="line">18:51:12.378 -&gt; </span><br><span class="line">18:51:12.378 -&gt; </span><br><span class="line">18:51:12.378 -&gt; Backtrace: 0x40083931:0x3ffbed5c |&lt;-CORRUPTED</span><br><span class="line">18:51:12.414 -&gt; </span><br><span class="line">18:51:12.414 -&gt; </span><br><span class="line">18:51:12.414 -&gt; </span><br><span class="line">18:51:12.414 -&gt; </span><br><span class="line">18:51:12.414 -&gt; ELF file SHA256: 291ef283067b9aa7</span><br><span class="line">18:51:12.414 -&gt; </span><br><span class="line">18:51:12.493 -&gt; Rebooting...</span><br></pre></td></tr></table></figure>
<p>解决方法有两个，要么让这个任务暂停给出其他任务一定的cpu时间，要么把优先级改为<code>0</code>，我这里就直接把优先级改成0了</p>
<h4 id="示例：cpu0刷新tft屏幕-cpu1使用simplefoc控制无刷电机"><a href="#示例：cpu0刷新tft屏幕-cpu1使用simplefoc控制无刷电机" class="headerlink" title="示例：cpu0刷新tft屏幕,cpu1使用simplefoc控制无刷电机"></a>示例：cpu0刷新tft屏幕,cpu1使用simplefoc控制无刷电机</h4><p>其中，tft屏幕任务代码来自<code>#include &quot;Ucglib.h&quot;</code>的示例程序，foc控制任务代码来自<code>#include &lt;SimpleFOC.h&gt;</code>的示例程序</p>
<p>虽然但是，就这两个任务而言，其实就算都在<code>cpu1</code>执行也无所谓hhh</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;SimpleFOC.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;SPI.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Ucglib.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;soc/soc.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;soc/rtc_cntl_reg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;esp_task_wdt.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">Ucglib_ST7735_18x128x160_SWSPI <span class="title function_">ucg</span><span class="params">(<span class="comment">/*sclk=*/</span> <span class="number">19</span>, <span class="comment">/*data=*/</span> <span class="number">18</span>, <span class="comment">/*cd=*/</span> <span class="number">16</span>, <span class="comment">/*cs=*/</span> <span class="number">17</span>, <span class="comment">/*reset=*/</span> <span class="number">5</span>)</span>;</span><br><span class="line">MagneticSensorI2C sensor = MagneticSensorI2C(AS5600_I2C);</span><br><span class="line">BLDCMotor motor = BLDCMotor(<span class="number">11</span>);</span><br><span class="line">BLDCDriver3PWM driver = BLDCDriver3PWM(<span class="number">25</span>, <span class="number">26</span>, <span class="number">27</span>, <span class="number">14</span>);</span><br><span class="line"><span class="type">float</span> target_angle = <span class="number">0</span>;</span><br><span class="line">Commander command = Commander(Serial);</span><br><span class="line"><span class="type">void</span> <span class="title function_">doTarget</span><span class="params">(<span class="type">char</span>* cmd)</span> &#123; command.scalar(&amp;target_angle, cmd); &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  xTaskCreatePinnedToCore(Task1code, <span class="string">&quot;Task1&quot;</span>, <span class="number">10000</span>, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>,  <span class="number">0</span>);</span><br><span class="line">  ucg.begin(UCG_FONT_MODE_TRANSPARENT);</span><br><span class="line">  ucg.setColor(<span class="number">0</span>, <span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">  ucg.setColor(<span class="number">1</span>, <span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">  ucg.setColor(<span class="number">2</span>, <span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">  ucg.setColor(<span class="number">3</span>, <span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  sensor.init();</span><br><span class="line">  motor.linkSensor(&amp;sensor);</span><br><span class="line">  driver.voltage_power_supply = <span class="number">12</span>;</span><br><span class="line">  driver.init();</span><br><span class="line">  motor.linkDriver(&amp;driver);</span><br><span class="line">  motor.foc_modulation = FOCModulationType::SpaceVectorPWM;</span><br><span class="line">  motor.controller = MotionControlType::angle;</span><br><span class="line">  motor.PID_velocity.P = <span class="number">0.2f</span>;</span><br><span class="line">  motor.PID_velocity.I = <span class="number">20</span>;</span><br><span class="line">  motor.voltage_limit = <span class="number">5</span>;</span><br><span class="line">  motor.LPF_velocity.Tf = <span class="number">0.01f</span>;</span><br><span class="line">  motor.P_angle.P = <span class="number">20</span>;</span><br><span class="line">  motor.velocity_limit = <span class="number">40</span>;</span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line">  motor.useMonitoring(Serial);</span><br><span class="line">  motor.init();</span><br><span class="line">  motor.initFOC();</span><br><span class="line">  command.add(<span class="string">&#x27;T&#x27;</span>, doTarget, <span class="string">&quot;target angle&quot;</span>);</span><br><span class="line">  Serial.println(F(<span class="string">&quot;Motor ready.&quot;</span>));</span><br><span class="line">  Serial.println(F(<span class="string">&quot;Set the target angle using serial terminal:&quot;</span>));</span><br><span class="line">  _delay(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">uint8_t</span> z = <span class="number">127</span>;</span><br><span class="line"><span class="type">uint8_t</span> <span class="title function_">lcg_rnd</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  z = (<span class="type">uint8_t</span>)((<span class="type">uint16_t</span>)<span class="number">65</span>*(<span class="type">uint16_t</span>)z + (<span class="type">uint16_t</span>)<span class="number">17</span>);</span><br><span class="line">  <span class="keyword">return</span> z;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">draw_text</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  ucg.setFont(ucg_font_ncenR14_tr);</span><br><span class="line">  ucg.setColor(lcg_rnd(),lcg_rnd(),lcg_rnd());</span><br><span class="line">  ucg.setPrintPos(<span class="number">0</span>,<span class="number">20</span>);</span><br><span class="line">  ucg.print(<span class="string">&quot;The quick brown&quot;</span>);</span><br><span class="line">  ucg.setPrintPos(<span class="number">0</span>,<span class="number">40</span>);</span><br><span class="line">  ucg.print(<span class="string">&quot;fox jumps over&quot;</span>);</span><br><span class="line">  ucg.setPrintPos(<span class="number">0</span>,<span class="number">60</span>);</span><br><span class="line">  ucg.print(<span class="string">&quot;the lazy dog&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">draw_box</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  <span class="type">ucg_int_t</span> x, y, w, h;</span><br><span class="line">  ucg.setColor(lcg_rnd(),lcg_rnd(),lcg_rnd());</span><br><span class="line">  x = lcg_rnd() &amp; <span class="number">31</span>;</span><br><span class="line">  y = lcg_rnd() &amp; <span class="number">31</span>;</span><br><span class="line">  w = <span class="number">63</span>;</span><br><span class="line">  w += lcg_rnd() &amp; <span class="number">31</span>;</span><br><span class="line">  h = <span class="number">63</span>;</span><br><span class="line">  h += lcg_rnd() &amp; <span class="number">31</span>;</span><br><span class="line">  ucg.drawBox(x,y,w, h);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">draw_gradient_box</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  <span class="type">ucg_int_t</span> x, y, w, h;</span><br><span class="line">  <span class="type">static</span> <span class="type">uint8_t</span> idx = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">switch</span>(idx &amp; <span class="number">3</span>)&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>: ucg.setColor(<span class="number">0</span>, lcg_rnd(),lcg_rnd(),lcg_rnd()); <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>: ucg.setColor(<span class="number">1</span>, lcg_rnd(),lcg_rnd(),lcg_rnd()); <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>: ucg.setColor(<span class="number">2</span>, lcg_rnd(),lcg_rnd(),lcg_rnd()); <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>: ucg.setColor(<span class="number">3</span>, lcg_rnd(),lcg_rnd(),lcg_rnd()); <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  idx++;</span><br><span class="line">  x = lcg_rnd() &amp; <span class="number">31</span>;</span><br><span class="line">  y = lcg_rnd() &amp; <span class="number">31</span>;</span><br><span class="line">  w = <span class="number">63</span>;</span><br><span class="line">  w += lcg_rnd() &amp; <span class="number">31</span>;</span><br><span class="line">  h = <span class="number">63</span>;</span><br><span class="line">  h += lcg_rnd() &amp; <span class="number">31</span>;</span><br><span class="line">  ucg.drawGradientBox(x,y,w, h);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">uint16_t</span> <span class="title function_">measure</span><span class="params">(<span class="type">void</span> (*draw_fn)(<span class="type">void</span>))</span> &#123;</span><br><span class="line">  <span class="type">uint16_t</span> FPS10 = <span class="number">0</span>;</span><br><span class="line">  <span class="type">uint32_t</span> time;</span><br><span class="line"></span><br><span class="line">  ucg.clearScreen();</span><br><span class="line"></span><br><span class="line">  time = millis() + <span class="number">10</span>*<span class="number">1000</span>;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    draw_fn();</span><br><span class="line">    FPS10++;</span><br><span class="line">  &#125; <span class="keyword">while</span>( millis() &lt; time );</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> FPS10;  </span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> u8d_tab[<span class="number">3</span>]  = &#123; <span class="number">100</span>, <span class="number">10</span>, <span class="number">1</span> &#125; ;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *<span class="title function_">u8dp</span><span class="params">(<span class="type">char</span> * dest, <span class="type">uint8_t</span> v)</span>&#123;</span><br><span class="line">  <span class="type">uint8_t</span> pos;</span><br><span class="line">  <span class="type">uint8_t</span> d;</span><br><span class="line">  <span class="type">uint8_t</span> c;</span><br><span class="line">  <span class="keyword">for</span>( pos = <span class="number">0</span>; pos &lt; <span class="number">3</span>; pos++ )</span><br><span class="line">  &#123;</span><br><span class="line">      d = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">      c = *(u8d_tab+pos);</span><br><span class="line">      <span class="keyword">while</span>( v &gt;= c )</span><br><span class="line">      &#123;</span><br><span class="line">	v -= c;</span><br><span class="line">	d++;</span><br><span class="line">      &#125;</span><br><span class="line">      dest[pos] = d;</span><br><span class="line">  &#125;  </span><br><span class="line">  dest[<span class="number">3</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">  <span class="keyword">return</span> dest;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *<span class="title function_">u8d</span><span class="params">(<span class="type">uint8_t</span> v, <span class="type">uint8_t</span> d)</span>&#123;</span><br><span class="line">  <span class="type">static</span> <span class="type">char</span> buf[<span class="number">8</span>];</span><br><span class="line">  d = <span class="number">3</span>-d;</span><br><span class="line">  <span class="keyword">return</span> u8dp(buf, v) + d;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *<span class="title function_">convert_FPS</span><span class="params">(<span class="type">uint16_t</span> fps)</span> &#123;</span><br><span class="line">  <span class="type">static</span> <span class="type">char</span> buf[<span class="number">6</span>];</span><br><span class="line">  <span class="built_in">strcpy</span>(buf, u8d( (<span class="type">uint8_t</span>)(fps/<span class="number">10</span>), <span class="number">3</span>));</span><br><span class="line">  buf[<span class="number">3</span>] =  <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">  buf[<span class="number">4</span>] = (fps % <span class="number">10</span>) + <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">  buf[<span class="number">5</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">  <span class="keyword">return</span> buf;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">show_result</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *s, <span class="type">uint16_t</span> fps)</span>  &#123;</span><br><span class="line">  ucg.clearScreen();</span><br><span class="line">  ucg.setFont(ucg_font_helvR18_tr);</span><br><span class="line">  ucg.setColor(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>);</span><br><span class="line">  ucg.setPrintPos(<span class="number">0</span>,<span class="number">25</span>);</span><br><span class="line">  ucg.print(s);</span><br><span class="line">  ucg.setPrintPos(<span class="number">0</span>,<span class="number">50</span>);</span><br><span class="line">  ucg.print(convert_FPS(fps));  </span><br><span class="line">  delay(<span class="number">2000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Task1code</span><span class="params">(<span class="type">void</span> * parameter)</span> &#123;</span><br><span class="line">  Serial.print(<span class="string">&quot;Task1 running on core &quot;</span>);</span><br><span class="line">  Serial.println(xPortGetCoreID());</span><br><span class="line">  <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">    vTaskDelay(<span class="number">10</span>);</span><br><span class="line">    show_result(<span class="string">&quot;Text&quot;</span>, measure(draw_text));</span><br><span class="line">    show_result(<span class="string">&quot;Box&quot;</span>, measure(draw_box));</span><br><span class="line">    show_result(<span class="string">&quot;Gradient&quot;</span>, measure(draw_gradient_box));</span><br><span class="line">    delay(<span class="number">500</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  motor.loopFOC();</span><br><span class="line">  motor.move(target_angle);</span><br><span class="line">  command.run();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="复杂应用"><a href="#复杂应用" class="headerlink" title="复杂应用"></a>复杂应用</h2><h3 id="无线配网"><a href="#无线配网" class="headerlink" title="无线配网"></a>无线配网</h3><p>这个其实工作量挺大的，直接抄<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41650023/article/details/124674493">别人抄的了</a></p>
<h4 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h4><h5 id="主程序"><a href="#主程序" class="headerlink" title="主程序"></a>主程序</h5><details>
  <summary>main.ino</summary>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;WiFiUser.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> resetPin = <span class="number">0</span>;                    <span class="comment">//设置重置按键引脚,用于删除WiFi信息</span></span><br><span class="line"><span class="type">int</span> connectTimeOut_s = <span class="number">15</span>;                 <span class="comment">//WiFi连接超时时间，单位秒</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  pinMode(resetPin, INPUT_PULLUP);     <span class="comment">//按键上拉输入模式(默认高电平输入,按下时下拉接到低电平)</span></span><br><span class="line">  Serial.begin(<span class="number">115200</span>);                <span class="comment">//波特率</span></span><br><span class="line">  LEDinit();                           <span class="comment">//LED用于显示WiFi状态</span></span><br><span class="line">  connectToWiFi(connectTimeOut_s);     <span class="comment">//连接wifi，传入的是wifi连接等待时间15s</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!digitalRead(resetPin)) <span class="comment">//长按5秒(P0)清除网络配置信息</span></span><br><span class="line">  &#123;</span><br><span class="line">    delay(<span class="number">5000</span>);              <span class="comment">//哈哈哈哈，这样不准确</span></span><br><span class="line">    <span class="keyword">if</span> (!digitalRead(resetPin)) </span><br><span class="line">    &#123;</span><br><span class="line">      Serial.println(<span class="string">&quot;\n按键已长按5秒,正在清空网络连保存接信息.&quot;</span>);</span><br><span class="line">      restoreWiFi();     <span class="comment">//删除保存的wifi信息</span></span><br><span class="line">      ESP.restart();              <span class="comment">//重启复位esp32</span></span><br><span class="line">      Serial.println(<span class="string">&quot;已重启设备.&quot;</span>);<span class="comment">//有机会读到这里吗？</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  checkDNS_HTTP();                  <span class="comment">//检测客户端DNS&amp;HTTP请求，也就是检查配网页面那部分</span></span><br><span class="line">  checkConnect(<span class="literal">true</span>);               <span class="comment">//检测网络连接状态，参数true表示如果断开重新连接</span></span><br><span class="line"> </span><br><span class="line">  delay(<span class="number">30</span>); </span><br><span class="line">&#125;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

</details>

<h5 id="库头文件"><a href="#库头文件" class="headerlink" title="库头文件"></a>库头文件</h5><details>
  <summary>WiFiUser.h</summary>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __WIFIUSER_H__</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __WIFIUSER_H__</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WiFi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;DNSServer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WebServer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESPmDNS.h&gt;</span>      <span class="comment">//用于设备域名 MDNS.begin(&quot;esp32&quot;)</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;esp_wifi.h&gt;</span>     <span class="comment">//用于esp_wifi_restore() 删除保存的wifi信息</span></span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">extern</span> <span class="type">const</span> <span class="type">int</span> LED;                         <span class="comment">//设置LED引脚</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">const</span> <span class="type">char</span>* HOST_NAME;                 <span class="comment">//设置设备名</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> connectTimeOut_s;                 <span class="comment">//WiFi连接超时时间，单位秒</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//===========需要调用的函数===========</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">checkConnect</span><span class="params">(<span class="type">bool</span> reConnect)</span>;    <span class="comment">//检测wifi是否已经连接</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">restoreWiFi</span><span class="params">()</span>;                   <span class="comment">//删除保存的wifi信息</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">LEDinit</span><span class="params">()</span>;                       <span class="comment">//LED初始化</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">checkDNS_HTTP</span><span class="params">()</span>;                 <span class="comment">//检测客户端DNS&amp;HTTP请求</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">connectToWiFi</span><span class="params">(<span class="type">int</span> timeOut_s)</span>;    <span class="comment">//连接WiFi</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//===========内部函数===========</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">handleRoot</span><span class="params">()</span>;                    <span class="comment">//处理网站根目录的访问请求</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">handleConfigWifi</span><span class="params">()</span> ;             <span class="comment">//提交数据后的提示页面</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">handleNotFound</span><span class="params">()</span>;                <span class="comment">//处理404情况的函数&#x27;handleNotFound&#x27;</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">initSoftAP</span><span class="params">()</span>;                    <span class="comment">//进入AP模式</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">initDNS</span><span class="params">()</span>;                       <span class="comment">//开启DNS服务器</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">initWebServer</span><span class="params">()</span>;                 <span class="comment">//初始化WebServer</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">scanWiFi</span><span class="params">()</span>;                      <span class="comment">//扫描附近的WiFi，为了显示在配网界面</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">wifiConfig</span><span class="params">()</span>;                    <span class="comment">//配置配网功能</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">blinkLED</span><span class="params">(<span class="type">int</span> led, <span class="type">int</span> n, <span class="type">int</span> t)</span>; <span class="comment">//LED闪烁函数        //用不上LED可删除</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

</details>

<h5 id="库文件"><a href="#库文件" class="headerlink" title="库文件"></a>库文件</h5><details>
  <summary>WiFiUser.cpp</summary>
这个程序原作者写了`WiFi.hostname(HOST_NAME);`实测报错，注释掉也不影响使用

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;WiFiUser.h&quot;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="type">const</span> byte DNS_PORT = <span class="number">53</span>;                  <span class="comment">//设置DNS端口号</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> webPort = <span class="number">80</span>;                    <span class="comment">//设置Web端口号</span></span><br><span class="line"> </span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* AP_SSID  = <span class="string">&quot;ESP32-4_1&quot;</span>;        <span class="comment">//设置AP热点名称</span></span><br><span class="line"><span class="comment">//const char* AP_PASS  = &quot;&quot;;               //这里不设置设置AP热点密码</span></span><br><span class="line"> </span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* HOST_NAME = <span class="string">&quot;MY_ESP32&quot;</span>;        <span class="comment">//设置设备名</span></span><br><span class="line">String scanNetworksID = <span class="string">&quot;&quot;</span>;                <span class="comment">//用于储存扫描到的WiFi ID</span></span><br><span class="line"> </span><br><span class="line">IPAddress <span class="title function_">apIP</span><span class="params">(<span class="number">192</span>, <span class="number">168</span>, <span class="number">4</span>, <span class="number">1</span>)</span>;            <span class="comment">//设置AP的IP地址</span></span><br><span class="line"> </span><br><span class="line">String wifi_ssid = <span class="string">&quot;&quot;</span>;                     <span class="comment">//暂时存储wifi账号密码</span></span><br><span class="line">String wifi_pass = <span class="string">&quot;&quot;</span>;                     <span class="comment">//暂时存储wifi账号密码</span></span><br><span class="line"> </span><br><span class="line"><span class="type">const</span> <span class="type">int</span> LED = <span class="number">2</span>;                         <span class="comment">//设置LED引脚</span></span><br><span class="line"> </span><br><span class="line">DNSServer dnsServer;                       <span class="comment">//创建dnsServer实例</span></span><br><span class="line">WebServer <span class="title function_">server</span><span class="params">(webPort)</span>;                 <span class="comment">//开启web服务, 创建TCP SERVER,参数: 端口号,最大连接数</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ROOT_HTML  <span class="string">&quot;&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;title&gt;WIFI&lt;/title&gt;&lt;meta name=\&quot;viewport\&quot; content=\&quot;width=device-width, initial-scale=1\&quot;&gt;&lt;/head&gt;&lt;style type=\&quot;text/css\&quot;&gt;.input&#123;display: block; margin-top: 10px;&#125;.input span&#123;width: 100px; float: left; float: left; height: 36px; line-height: 36px;&#125;.input input&#123;height: 30px;width: 200px;&#125;.btn&#123;width: 120px; height: 35px; background-color: #000000; border:0px; color:#ffffff; margin-top:15px; margin-left:100px;&#125;&lt;/style&gt;&lt;body&gt;&lt;form method=\&quot;POST\&quot; action=\&quot;configwifi\&quot;&gt;&lt;label class=\&quot;input\&quot;&gt;&lt;span&gt;WiFi SSID&lt;/span&gt;&lt;input type=\&quot;text\&quot; name=\&quot;ssid\&quot; value=\&quot;\&quot;&gt;&lt;/label&gt;&lt;label class=\&quot;input\&quot;&gt;&lt;span&gt;WiFi PASS&lt;/span&gt; &lt;input type=\&quot;text\&quot;  name=\&quot;pass\&quot;&gt;&lt;/label&gt;&lt;input class=\&quot;btn\&quot; type=\&quot;submit\&quot; name=\&quot;submit\&quot; value=\&quot;Submie\&quot;&gt; &lt;p&gt;&lt;span&gt; Nearby wifi:&lt;/P&gt;&lt;/form&gt;&quot;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 处理网站根目录的访问请求</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">handleRoot</span><span class="params">()</span> </span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (server.hasArg(<span class="string">&quot;selectSSID&quot;</span>)) &#123;</span><br><span class="line">    server.send(<span class="number">200</span>, <span class="string">&quot;text/html&quot;</span>, ROOT_HTML + scanNetworksID + <span class="string">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span>);   <span class="comment">//scanNetWprksID是扫描到的wifi</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    server.send(<span class="number">200</span>, <span class="string">&quot;text/html&quot;</span>, ROOT_HTML + scanNetworksID + <span class="string">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span>);   </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 提交数据后的提示页面</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">handleConfigWifi</span><span class="params">()</span>               <span class="comment">//返回http状态</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (server.hasArg(<span class="string">&quot;ssid&quot;</span>))          <span class="comment">//判断是否有账号参数</span></span><br><span class="line">  &#123;</span><br><span class="line">    Serial.print(<span class="string">&quot;got ssid:&quot;</span>);</span><br><span class="line">    wifi_ssid = server.arg(<span class="string">&quot;ssid&quot;</span>);   <span class="comment">//获取html表单输入框name名为&quot;ssid&quot;的内容</span></span><br><span class="line"> </span><br><span class="line">    Serial.println(wifi_ssid);</span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">else</span>                                <span class="comment">//没有参数</span></span><br><span class="line">  &#123; </span><br><span class="line">    Serial.println(<span class="string">&quot;error, not found ssid&quot;</span>);</span><br><span class="line">    server.send(<span class="number">200</span>, <span class="string">&quot;text/html&quot;</span>, <span class="string">&quot;&lt;meta charset=&#x27;UTF-8&#x27;&gt;error, not found ssid&quot;</span>); <span class="comment">//返回错误页面</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//密码与账号同理</span></span><br><span class="line">  <span class="keyword">if</span> (server.hasArg(<span class="string">&quot;pass&quot;</span>)) </span><br><span class="line">  &#123;</span><br><span class="line">    Serial.print(<span class="string">&quot;got password:&quot;</span>);</span><br><span class="line">    wifi_pass = server.arg(<span class="string">&quot;pass&quot;</span>);  <span class="comment">//获取html表单输入框name名为&quot;pwd&quot;的内容</span></span><br><span class="line">    Serial.println(wifi_pass);</span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">else</span> </span><br><span class="line">  &#123;</span><br><span class="line">    Serial.println(<span class="string">&quot;error, not found password&quot;</span>);</span><br><span class="line">    server.send(<span class="number">200</span>, <span class="string">&quot;text/html&quot;</span>, <span class="string">&quot;&lt;meta charset=&#x27;UTF-8&#x27;&gt;error, not found password&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  server.send(<span class="number">200</span>, <span class="string">&quot;text/html&quot;</span>, <span class="string">&quot;&lt;meta charset=&#x27;UTF-8&#x27;&gt;SSID：&quot;</span> + wifi_ssid + <span class="string">&quot;&lt;br /&gt;password:&quot;</span> + wifi_pass + <span class="string">&quot;&lt;br /&gt;已取得WiFi信息,正在尝试连接,请手动关闭此页面。&quot;</span>); <span class="comment">//返回保存成功页面</span></span><br><span class="line">  delay(<span class="number">2000</span>);</span><br><span class="line">  WiFi.softAPdisconnect(<span class="literal">true</span>);     <span class="comment">//参数设置为true，设备将直接关闭接入点模式，即关闭设备所建立的WiFi网络。</span></span><br><span class="line">  server.close();                  <span class="comment">//关闭web服务</span></span><br><span class="line">  WiFi.softAPdisconnect();         <span class="comment">//在不输入参数的情况下调用该函数,将关闭接入点模式,并将当前配置的AP热点网络名和密码设置为空值.</span></span><br><span class="line">  Serial.println(<span class="string">&quot;WiFi Connect SSID:&quot;</span> + wifi_ssid + <span class="string">&quot;  PASS:&quot;</span> + wifi_pass);</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span> (WiFi.status() != WL_CONNECTED)    <span class="comment">//wifi没有连接成功</span></span><br><span class="line">  &#123;</span><br><span class="line">    Serial.println(<span class="string">&quot;开始调用连接函数connectToWiFi()..&quot;</span>);</span><br><span class="line">    connectToWiFi(connectTimeOut_s);</span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    Serial.println(<span class="string">&quot;提交的配置信息自动连接成功..&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 处理404情况的函数&#x27;handleNotFound&#x27;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">handleNotFound</span><span class="params">()</span>           <span class="comment">// 当浏览器请求的网络资源无法在服务器找到时通过此自定义函数处理</span></span><br><span class="line">&#123;           </span><br><span class="line">  handleRoot();                 <span class="comment">//访问不存在目录则返回配置页面</span></span><br><span class="line">  <span class="comment">//   server.send(404, &quot;text/plain&quot;, &quot;404: Not found&quot;);</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 进入AP模式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">initSoftAP</span><span class="params">()</span> &#123;</span><br><span class="line">  WiFi.mode(WIFI_AP);                                           <span class="comment">//配置为AP模式</span></span><br><span class="line">  WiFi.softAPConfig(apIP, apIP, IPAddress(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0</span>));   <span class="comment">//设置AP热点IP和子网掩码</span></span><br><span class="line">  <span class="keyword">if</span> (WiFi.softAP(AP_SSID))                                     <span class="comment">//开启AP热点,如需要密码则添加第二个参数</span></span><br><span class="line">  &#123;                           </span><br><span class="line">    <span class="comment">//打印相关信息</span></span><br><span class="line">    Serial.println(<span class="string">&quot;ESP-32S SoftAP is right.&quot;</span>);</span><br><span class="line">    Serial.print(<span class="string">&quot;Soft-AP IP address = &quot;</span>);</span><br><span class="line">    Serial.println(WiFi.softAPIP());                                                <span class="comment">//接入点ip</span></span><br><span class="line">    Serial.println(String(<span class="string">&quot;MAC address = &quot;</span>)  + WiFi.softAPmacAddress().c_str());    <span class="comment">//接入点mac</span></span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">else</span>                                                  <span class="comment">//开启AP热点失败</span></span><br><span class="line">  &#123; </span><br><span class="line">    Serial.println(<span class="string">&quot;WiFiAP Failed&quot;</span>);</span><br><span class="line">    delay(<span class="number">1000</span>);</span><br><span class="line">    Serial.println(<span class="string">&quot;restart now...&quot;</span>);</span><br><span class="line">    ESP.restart();                                      <span class="comment">//重启复位esp32</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 开启DNS服务器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">initDNS</span><span class="params">()</span> </span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (dnsServer.start(DNS_PORT, <span class="string">&quot;*&quot;</span>, apIP))   <span class="comment">//判断将所有地址映射到esp32的ip上是否成功</span></span><br><span class="line">  &#123;</span><br><span class="line">    Serial.println(<span class="string">&quot;start dnsserver success.&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    Serial.println(<span class="string">&quot;start dnsserver failed.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 初始化WebServer</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">initWebServer</span><span class="params">()</span> </span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (MDNS.begin(<span class="string">&quot;esp32&quot;</span>))      <span class="comment">//给设备设定域名esp32,完整的域名是esp32.local</span></span><br><span class="line">  &#123;</span><br><span class="line">    Serial.println(<span class="string">&quot;MDNS responder started&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//必须添加第二个参数HTTP_GET，以下面这种格式去写，否则无法强制门户</span></span><br><span class="line">  server.on(<span class="string">&quot;/&quot;</span>, HTTP_GET, handleRoot);                      <span class="comment">//  当浏览器请求服务器根目录(网站首页)时调用自定义函数handleRoot处理，设置主页回调函数，必须添加第二个参数HTTP_GET，否则无法强制门户</span></span><br><span class="line">  server.on(<span class="string">&quot;/configwifi&quot;</span>, HTTP_POST, handleConfigWifi);     <span class="comment">//  当浏览器请求服务器/configwifi(表单字段)目录时调用自定义函数handleConfigWifi处理</span></span><br><span class="line">                                                            </span><br><span class="line">  server.onNotFound(handleNotFound);                         <span class="comment">//当浏览器请求的网络资源无法在服务器找到时调用自定义函数handleNotFound处理</span></span><br><span class="line"> </span><br><span class="line">  server.begin();                                           <span class="comment">//启动TCP SERVER</span></span><br><span class="line"> </span><br><span class="line">  Serial.println(<span class="string">&quot;WebServer started!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 扫描附近的WiFi，为了显示在配网界面</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">scanWiFi</span><span class="params">()</span> &#123;</span><br><span class="line">  Serial.println(<span class="string">&quot;scan start&quot;</span>);</span><br><span class="line">  Serial.println(<span class="string">&quot;---------&gt;&quot;</span>);</span><br><span class="line">  <span class="comment">// 扫描附近WiFi</span></span><br><span class="line">  <span class="type">int</span> n = WiFi.scanNetworks();</span><br><span class="line">  Serial.println(<span class="string">&quot;scan done&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">    Serial.println(<span class="string">&quot;no networks found&quot;</span>);</span><br><span class="line">    scanNetworksID = <span class="string">&quot;no networks found&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    Serial.print(n);</span><br><span class="line">    Serial.println(<span class="string">&quot; networks found&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; ++i) &#123;</span><br><span class="line">      <span class="comment">// Print SSID and RSSI for each network found</span></span><br><span class="line">      Serial.print(i + <span class="number">1</span>);</span><br><span class="line">      Serial.print(<span class="string">&quot;: &quot;</span>);</span><br><span class="line">      Serial.print(WiFi.SSID(i));</span><br><span class="line">      Serial.print(<span class="string">&quot; (&quot;</span>);</span><br><span class="line">      Serial.print(WiFi.RSSI(i));</span><br><span class="line">      Serial.print(<span class="string">&quot;)&quot;</span>);</span><br><span class="line">      Serial.println((WiFi.encryptionType(i) == WIFI_AUTH_OPEN) ? <span class="string">&quot; &quot;</span> : <span class="string">&quot;*&quot;</span>);</span><br><span class="line">      scanNetworksID += <span class="string">&quot;&lt;P&gt;&quot;</span> + WiFi.SSID(i) + <span class="string">&quot;&lt;/P&gt;&quot;</span>;</span><br><span class="line">      delay(<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 连接WiFi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">connectToWiFi</span><span class="params">(<span class="type">int</span> timeOut_s)</span> &#123;</span><br><span class="line">  <span class="comment">//WiFi.hostname(HOST_NAME);             //设置设备名</span></span><br><span class="line">  Serial.println(<span class="string">&quot;进入connectToWiFi()函数&quot;</span>);</span><br><span class="line">  WiFi.mode(WIFI_STA);                        <span class="comment">//设置为STA模式并连接WIFI</span></span><br><span class="line">  WiFi.setAutoConnect(<span class="literal">true</span>);                  <span class="comment">//设置自动连接    </span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (wifi_ssid != <span class="string">&quot;&quot;</span>)                        <span class="comment">//wifi_ssid不为空，意味着从网页读取到wifi</span></span><br><span class="line">  &#123;</span><br><span class="line">    Serial.println(<span class="string">&quot;用web配置信息连接.&quot;</span>);</span><br><span class="line">    WiFi.begin(wifi_ssid.c_str(), wifi_pass.c_str()); <span class="comment">//c_str(),获取该字符串的指针</span></span><br><span class="line">    wifi_ssid = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    wifi_pass = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">else</span>                                        <span class="comment">//未从网页读取到wifi</span></span><br><span class="line">  &#123;</span><br><span class="line">    Serial.println(<span class="string">&quot;用nvs保存的信息连接.&quot;</span>);</span><br><span class="line">    WiFi.begin();                             <span class="comment">//begin()不传入参数，默认连接上一次连接成功的wifi</span></span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="type">int</span> Connect_time = <span class="number">0</span>;                       <span class="comment">//用于连接计时，如果长时间连接不成功，复位设备</span></span><br><span class="line">  <span class="keyword">while</span> (WiFi.status() != WL_CONNECTED)       <span class="comment">//等待WIFI连接成功</span></span><br><span class="line">  &#123;  </span><br><span class="line">    Serial.print(<span class="string">&quot;.&quot;</span>);                        <span class="comment">//一共打印30个点点</span></span><br><span class="line">    digitalWrite(LED, !digitalRead(LED));     </span><br><span class="line">    delay(<span class="number">500</span>);</span><br><span class="line">    Connect_time ++;</span><br><span class="line">                                       </span><br><span class="line">    <span class="keyword">if</span> (Connect_time &gt; <span class="number">2</span> * timeOut_s)         <span class="comment">//长时间连接不上，重新进入配网页面</span></span><br><span class="line">    &#123; </span><br><span class="line">      digitalWrite(LED, LOW);</span><br><span class="line">      Serial.println(<span class="string">&quot;&quot;</span>);                     <span class="comment">//主要目的是为了换行符</span></span><br><span class="line">      Serial.println(<span class="string">&quot;WIFI autoconnect fail, start AP for webconfig now...&quot;</span>);</span><br><span class="line">      wifiConfig();                           <span class="comment">//开始配网功能</span></span><br><span class="line">      <span class="keyword">return</span>;                                 <span class="comment">//跳出 防止无限初始化</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (WiFi.status() == WL_CONNECTED)          <span class="comment">//如果连接成功</span></span><br><span class="line">  &#123;</span><br><span class="line">    Serial.println(<span class="string">&quot;WIFI connect Success&quot;</span>);</span><br><span class="line">    Serial.<span class="built_in">printf</span>(<span class="string">&quot;SSID:%s&quot;</span>, WiFi.SSID().c_str());</span><br><span class="line">    Serial.<span class="built_in">printf</span>(<span class="string">&quot;, PSW:%s\r\n&quot;</span>, WiFi.psk().c_str());</span><br><span class="line">    Serial.print(<span class="string">&quot;LocalIP:&quot;</span>);</span><br><span class="line">    Serial.print(WiFi.localIP());</span><br><span class="line">    Serial.print(<span class="string">&quot; ,GateIP:&quot;</span>);</span><br><span class="line">    Serial.println(WiFi.gatewayIP());</span><br><span class="line">    Serial.print(<span class="string">&quot;WIFI status is:&quot;</span>);</span><br><span class="line">    Serial.print(WiFi.status());</span><br><span class="line">    digitalWrite(LED, HIGH);</span><br><span class="line">    server.stop();                            <span class="comment">//停止开发板所建立的网络服务器。</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 配置配网功能</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">wifiConfig</span><span class="params">()</span> </span><br><span class="line">&#123;</span><br><span class="line">  initSoftAP();   </span><br><span class="line">  initDNS();        </span><br><span class="line">  initWebServer();  </span><br><span class="line">  scanWiFi();       </span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 删除保存的wifi信息，这里的删除是删除存储在flash的信息。删除后wifi读不到上次连接的记录，需重新配网</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">restoreWiFi</span><span class="params">()</span> &#123;</span><br><span class="line">  delay(<span class="number">500</span>);</span><br><span class="line">  esp_wifi_restore();  <span class="comment">//删除保存的wifi信息</span></span><br><span class="line">  Serial.println(<span class="string">&quot;连接信息已清空,准备重启设备..&quot;</span>);</span><br><span class="line">  delay(<span class="number">10</span>);</span><br><span class="line">  blinkLED(LED, <span class="number">5</span>, <span class="number">500</span>); <span class="comment">//LED闪烁5次         //关于LED，不需要可删除 </span></span><br><span class="line">  digitalWrite(LED, LOW);                    <span class="comment">//关于LED，不需要可删除</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 检查wifi是否已经连接</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">checkConnect</span><span class="params">(<span class="type">bool</span> reConnect)</span> </span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (WiFi.status() != WL_CONNECTED)           <span class="comment">//wifi连接失败</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (digitalRead(LED) != LOW) </span><br><span class="line">      digitalWrite(LED, LOW);</span><br><span class="line">    <span class="keyword">if</span> (reConnect == <span class="literal">true</span> &amp;&amp; WiFi.getMode() != WIFI_AP &amp;&amp; WiFi.getMode() != WIFI_AP_STA ) </span><br><span class="line">    &#123;</span><br><span class="line">      Serial.println(<span class="string">&quot;WIFI未连接.&quot;</span>);</span><br><span class="line">      Serial.println(<span class="string">&quot;WiFi Mode:&quot;</span>);</span><br><span class="line">      Serial.println(WiFi.getMode());</span><br><span class="line">      Serial.println(<span class="string">&quot;正在连接WiFi...&quot;</span>);</span><br><span class="line">      connectToWiFi(connectTimeOut_s);          <span class="comment">//连接wifi函数 </span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (digitalRead(LED) != HIGH)  </span><br><span class="line">    digitalWrite(LED, HIGH);                    <span class="comment">//wifi连接成功</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * LED闪烁函数        //用不上LED可删除</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">blinkLED</span><span class="params">(<span class="type">int</span> led, <span class="type">int</span> n, <span class="type">int</span> t)</span> </span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span> * n; i++) </span><br><span class="line">  &#123;</span><br><span class="line">    digitalWrite(led, !digitalRead(led));</span><br><span class="line">    delay(t);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * LED初始化</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">LEDinit</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  pinMode(LED, OUTPUT);                 <span class="comment">//配置LED口为输出口</span></span><br><span class="line">  digitalWrite(LED, LOW);               <span class="comment">//初始灯灭</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 检测客户端DNS&amp;HTTP请求</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">checkDNS_HTTP</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  dnsServer.processNextRequest();   <span class="comment">//检查客户端DNS请求</span></span><br><span class="line">  server.handleClient();            <span class="comment">//检查客户端(浏览器)http请求</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

</details>

<h4 id="使用及解析"><a href="#使用及解析" class="headerlink" title="使用及解析"></a>使用及解析</h4><blockquote>
<p>设备热点配网(Soft AP)：</p>
<ul>
<li>ESP32配置为AP模式</li>
<li>手机or电脑连接ESP32热点，发送WiFi和密码</li>
<li>ESP32设置为STA模式</li>
</ul>
</blockquote>
<blockquote>
<p>LED显示配网状态：</p>
<ul>
<li>LED闪烁：表示正在尝试连接网络</li>
<li>LED常亮：表示网络连接成功</li>
<li>LED常灭：表示等待配网</li>
<li>LED闪烁5次：表示已清除wifi信息</li>
</ul>
</blockquote>
<details>
  <summary>配网界面HTML原代码</summary>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;title&gt;WIFI</span><br><span class="line">            </span><br><span class="line">        &lt;/title&gt;</span><br><span class="line">        &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;&gt;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;style type=&quot;text/css&quot;&gt;</span><br><span class="line">        .input&#123;display: block; margin-top: 10px;&#125;</span><br><span class="line">        .input span&#123;width: 100px; float: left; float: left; height: 36px; line-height: 36px;&#125;</span><br><span class="line">        .input input&#123;height: 30px;width: 200px;&#125;</span><br><span class="line">        .btn&#123;width: 120px; height: 35px; background-color: #000000; border:0px; color:#ffffff; margin-top:15px; margin-left:100px;&#125;</span><br><span class="line">    &lt;/style&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;form method=&quot;POST&quot; action=&quot;configwifi&quot;&gt;</span><br><span class="line">            &lt;label class=&quot;input&quot;&gt;</span><br><span class="line">                &lt;span&gt;</span><br><span class="line">                    WiFi SSID  </span><br><span class="line">                &lt;/span&gt;</span><br><span class="line">                &lt;input type=&quot;text&quot; name=&quot;ssid&quot;&gt;</span><br><span class="line">            &lt;/label&gt;</span><br><span class="line">            &lt;label class=&quot;input&quot;&gt;</span><br><span class="line">                &lt;span&gt;</span><br><span class="line">                    WiFi PASS</span><br><span class="line">                &lt;/span&gt; </span><br><span class="line">                &lt;input type=&quot;text&quot;  name=&quot;pass&quot;&gt;</span><br><span class="line">            &lt;/label&gt;</span><br><span class="line">            &lt;input class=&quot;btn&quot; type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;Submie&quot;&gt;         </span><br><span class="line">            &lt;p&gt;</span><br><span class="line">                &lt;span&gt; Nearby wifi:</span><br><span class="line">            &lt;/P&gt;</span><br><span class="line">        &lt;/form&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
</details>

<h1 id="硬件设计-开发板制作"><a href="#硬件设计-开发板制作" class="headerlink" title="硬件设计(开发板制作)"></a>硬件设计(开发板制作)</h1><h2 id="官方文档"><a href="#官方文档" class="headerlink" title="官方文档"></a>官方文档</h2><blockquote>
<p>ESP32 ­WROOM ­32E 技术规格书</p>
</blockquote>


	<div class="row">
    <embed src="https://www.espressif.com.cn/sites/default/files/documentation/esp32-wroom-32e_esp32-wroom-32ue_datasheet_cn.pdf" width="100%" height="550" type="application/pdf">
	</div>




<blockquote>
<p>ESP32 硬件设计指南</p>
</blockquote>


	<div class="row">
    <embed src="https://www.espressif.com.cn/sites/default/files/documentation/esp32_hardware_design_guidelines_cn.pdf" width="100%" height="550" type="application/pdf">
	</div>




<h2 id="注意事项和启动配置"><a href="#注意事项和启动配置" class="headerlink" title="注意事项和启动配置"></a>注意事项和启动配置</h2><p>模块电源电压为3.3V，一般使用<code>AMS1117-3.3</code>为其供电，其中要注意EN引脚要使用RC电路延迟启动。使用引脚 GPIO0 和 GPIO2 配置启动方式：</p>
<p><img src="/2023/esp32-all-in-one/4fefe86e7eff4265ae7310bb73ff40d5.png"></p>
<p>GPIO2要常态为低电平。当EN引脚处于上升沿时，GPIO0高电平进入SPI启动模式，低电平进入串口下载模式。</p>
<p>自动下载电路能调整boot和en脚的电平变化来满足下载时序，这是一个常用的自动下载电路原理图：<br><img src="/2023/esp32-all-in-one/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20230624230937.png" alt="自动下载电路"><br>关于其工作原理众说纷纭，基本都不太一样，我也不是很清楚，实际自己做之后并不能工作，也没能找到原因。</p>
<p>因为自动下载电路不能工作，我自己设计的电路都是直接手动按按钮来配置引脚电平设置芯片启动方式。开发板默认EN拉高，IO2拉低，IO0拉高。直接上电即可进入spi启动模式运行flash的程序，如果上电使用按钮将EN拉低和IO0拉低，IO2依然默认拉低，然后停止下拉EN启动芯片即可进入下载模式。</p>
<h2 id="示例原理图"><a href="#示例原理图" class="headerlink" title="示例原理图"></a>示例原理图</h2><p>这是嘉立创的esp32开发板的<a target="_blank" rel="noopener" href="https://oshwhub.com/li-chuang-zhi-neng-ying-jian-bu/esp32-zui-xiao-ji-tong-ban-yan-zheng-ban">方案验证板</a>：<br><img src="/2023/esp32-all-in-one/Schematic_C2979602_ESP32%E6%A8%A1%E5%9D%97%E6%96%B9%E6%A1%88%E9%AA%8C%E8%AF%81%E6%9D%BF_2023-06-22.png"></p>
<h2 id="改进版原理图"><a href="#改进版原理图" class="headerlink" title="改进版原理图"></a>改进版原理图</h2><p>对于常见的esp32开发板我做出了一些修改：</p>
<ul>
<li>针脚改为向上的母座，减少很多接线的麻烦</li>
<li>usb转串口改为更便宜的ch340等(由于不想要自动下载电路使用的ch340n)</li>
<li>使用直插type-c母座方便焊接</li>
</ul>
<table>
<thead>
<tr>
<th align="center"><img src="/2023/esp32-all-in-one/QQ%E6%88%AA%E5%9B%BE20230625233426.png"></th>
<th align="center"><img src="/2023/esp32-all-in-one/QQ%E6%88%AA%E5%9B%BE20230625233539.png"></th>
</tr>
</thead>
<tbody><tr>
<td align="center">原理图</td>
<td align="center">PCB-3D</td>
</tr>
</tbody></table>
<p>这个设计还有一点就是模块化了esp32模组外围电路，包含了启动配置电路等，便于将来直接在其他工程中调用</p>
<blockquote>
<p>2023.6.29:纪念一下第一个正常使用的esp32开发板焊接完成投入使用<del>之前的每个版本都是自动下载电路出现问题这次直接删掉就成功了</del></p>
</blockquote>
<p><img src="/2023/esp32-all-in-one/2958a459c383be845a0020df33fd64e.jpg"></p>
<p>不得不提及一下图片里这个esp32模组的身世，来自于我tb买的esp32开发板，之前一次自制开发板验证过程中准备拆焊买的这个开发板的模组，但是放在焊台上开350度之后就忘记了，二十分钟之后抢救下来发现还能用hhh然后继续用来测试直到现在焊接到了这个新的开发板上</p>
<h1 id="可能遇到的错误"><a href="#可能遇到的错误" class="headerlink" title="可能遇到的错误"></a>可能遇到的错误</h1><h2 id="烧录报错-MD5-of-file-does-not-match-data-in-flash"><a href="#烧录报错-MD5-of-file-does-not-match-data-in-flash" class="headerlink" title="烧录报错 MD5 of file does not match data in flash"></a>烧录报错 MD5 of file does not match data in flash</h2><blockquote>
<p>MD5 of file does not match data in flash</p>
</blockquote>
<ul>
<li>安装<code>esptool.py</code>:<code>python -m pip install esptool</code></li>
<li>运行<code>python -m esptool --port COM5 write_flash_status --non-volatile 0</code> &#x2F;&#x2F;COM5替换成ESP32连接端口</li>
</ul>
<p>出现以下输出即表示成功</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">esptool.py v2.4.0</span><br><span class="line">Connecting........_</span><br><span class="line">Detecting chip type... ESP8266</span><br><span class="line">Chip is ESP8266EX</span><br><span class="line">Features: WiFi</span><br><span class="line">MAC: b4:e6:2d:68:3b:96</span><br><span class="line">Uploading stub...</span><br><span class="line">Running stub...</span><br><span class="line">Stub running...</span><br><span class="line">Initial flash status: 0x0200</span><br><span class="line">Setting flash status: 0x0000</span><br><span class="line">After flash status: 0x0000</span><br><span class="line">Hard resetting via RTS pin...</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意事项：这个命令在进入烧录模式的时候才可以使用，在linux和mac下，一定要使用sudo</p>
</blockquote>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a target="_blank" rel="noopener" href="https://randomnerdtutorials.com/esp32-pinout-reference-gpios/">https://randomnerdtutorials.com/esp32-pinout-reference-gpios/</a><br><a target="_blank" rel="noopener" href="https://deepbluembedded.com/esp32-pwm-tutorial-examples-analogwrite-arduino/">https://deepbluembedded.com/esp32-pwm-tutorial-examples-analogwrite-arduino/</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/6fb40b3d0c6d">https://www.jianshu.com/p/6fb40b3d0c6d</a><br><a target="_blank" rel="noopener" href="https://lingshunlab.com/">https://lingshunlab.com/</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41868901/article/details/104690524">https://blog.csdn.net/qq_41868901/article/details/104690524</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/supermodule/article/details/129313032">https://blog.csdn.net/supermodule/article/details/129313032</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42880082/article/details/121055405">https://blog.csdn.net/weixin_42880082/article/details/121055405</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42880082/article/details/120766154">https://blog.csdn.net/weixin_42880082/article/details/120766154</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41650023/article/details/124674493">https://blog.csdn.net/qq_41650023/article/details/124674493</a><br><a href="https://triority.cc/2023/xbox-python/">https://triority.cc/2023/xbox-python/</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/greyelectron/articles/16327709.html">https://www.cnblogs.com/greyelectron/articles/16327709.html</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41868901/article/details/106203642">https://blog.csdn.net/qq_41868901/article/details/106203642</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_27114397/category_7917392.html">https://blog.csdn.net/qq_27114397/category_7917392.html</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43353164/article/details/105060630">https://blog.csdn.net/weixin_43353164/article/details/105060630</a><br><a target="_blank" rel="noopener" href="https://www.yiboard.com/thread-1344-1-1.html">https://www.yiboard.com/thread-1344-1-1.html</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_62361151/article/details/130102202">https://blog.csdn.net/qq_62361151/article/details/130102202</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/145369083">https://zhuanlan.zhihu.com/p/145369083</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/z755924843/article/details/82704020">https://blog.csdn.net/z755924843/article/details/82704020</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/xq151750111/article/details/115142727">https://blog.csdn.net/xq151750111/article/details/115142727</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/Naisu_kun/article/details/86004049">https://blog.csdn.net/Naisu_kun/article/details/86004049</a><br><a target="_blank" rel="noopener" href="https://lastminuteengineers.com/handling-esp32-gpio-interrupts-tutorial/">https://lastminuteengineers.com/handling-esp32-gpio-interrupts-tutorial/</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://www.triority.cc/">Triority</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://triority.cc/2023/esp32-all-in-one/">http://triority.cc/2023/esp32-all-in-one/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://triority.cc" target="_blank">Triority's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/arduino/">arduino</a><a class="post-meta__tags" href="/tags/PCB%E8%AE%BE%E8%AE%A1/">PCB设计</a><a class="post-meta__tags" href="/tags/esp32/">esp32</a></div><div class="post_share"><div class="social-share" data-image="/img/esp32-pinout-chip-ESP-WROOM-32.webp" data-sites="twitter,wechat,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/xbox-python/" title="xbox手柄控制"><img class="cover" src="/img/QQ%E6%88%AA%E5%9B%BE20230227164056.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">xbox手柄控制</div></div></a></div><div class="next-post pull-right"><a href="/2023/lbg2/" title="喇叭沟第二弹"><img class="cover" src="/img/DSC03695(1).png" onerror="onerror=null;src='/img/friend_404.gif'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">喇叭沟第二弹</div></div></a></div></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/favicon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Triority</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">124</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">36</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">13</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Triority"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Triority" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:triority@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">The domain name of this website has been changed to triority.cc(Using CDN via cloudflare, recommended) / www.triority.cc(Connecting directly, works better in Chinese mainland). Please contact me if you have any questions.</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B6%85%E7%BA%A7%E6%97%A0%E6%95%8C%E5%9F%BA%E7%A1%80%E7%9A%84%E6%93%8D%E4%BD%9C"><span class="toc-number">2.</span> <span class="toc-text">超级无敌基础的操作</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BC%95%E8%84%9A%E5%92%8C%E8%B5%84%E6%BA%90%E5%88%86%E9%85%8D%E4%B8%8E%E4%BD%BF%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">引脚和资源分配与使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8D%E5%BB%BA%E8%AE%AE%E4%BD%BF%E7%94%A8%E6%88%96%E9%99%90%E5%88%B6%E4%BD%BF%E7%94%A8%E7%9A%84%E5%BC%95%E8%84%9A"><span class="toc-number">3.1.</span> <span class="toc-text">不建议使用或限制使用的引脚</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Strapping%E5%BC%95%E8%84%9A"><span class="toc-number">3.1.1.</span> <span class="toc-text">Strapping引脚</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E6%88%90%E5%9C%A8ESP-WROOM-32%E7%9A%84SPI-flash%E5%BC%95%E8%84%9A"><span class="toc-number">3.1.2.</span> <span class="toc-text">集成在ESP-WROOM-32的SPI flash引脚</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%85%E8%BE%93%E5%85%A5%E5%BC%95%E8%84%9A"><span class="toc-number">3.1.3.</span> <span class="toc-text">仅输入引脚</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%99%90%E5%88%B6%E4%BD%BF%E7%94%A8%E5%BC%95%E8%84%9A"><span class="toc-number">3.1.4.</span> <span class="toc-text">限制使用引脚</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%96%E8%AE%BE%E8%B5%84%E6%BA%90"><span class="toc-number">3.2.</span> <span class="toc-text">外设资源</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#18%E4%B8%AAADC%E9%80%9A%E9%81%93"><span class="toc-number">3.2.1.</span> <span class="toc-text">18个ADC通道</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">3.2.1.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B"><span class="toc-number">3.2.1.2.</span> <span class="toc-text">实例</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96%E6%A8%A1%E6%8B%9F%E5%80%BC%E5%8F%8A%E8%AE%BE%E7%BD%AE%E5%88%86%E8%BE%A8%E7%8E%87"><span class="toc-number">3.2.1.2.1.</span> <span class="toc-text">读取模拟值及设置分辨率</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96%E6%A8%A1%E6%8B%9F%E7%94%B5%E5%8E%8B-%E6%AF%AB%E4%BC%8F"><span class="toc-number">3.2.1.2.2.</span> <span class="toc-text">读取模拟电压(毫伏)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AEADC%E8%A1%B0%E5%87%8F"><span class="toc-number">3.2.1.2.3.</span> <span class="toc-text">设置ADC衰减</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E5%8F%AF%E8%AE%BE%E7%BD%AE%E9%A1%B9"><span class="toc-number">3.2.1.2.4.</span> <span class="toc-text">其他可设置项</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E7%BB%84SPI%E6%8E%A5%E5%8F%A3"><span class="toc-number">3.2.2.</span> <span class="toc-text">4组SPI接口</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-1"><span class="toc-number">3.2.2.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B-1"><span class="toc-number">3.2.2.2.</span> <span class="toc-text">实例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E7%BB%84UART%E6%8E%A5%E5%8F%A3"><span class="toc-number">3.2.3.</span> <span class="toc-text">3组UART接口</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#GPIO"><span class="toc-number">3.2.3.1.</span> <span class="toc-text">GPIO</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A1%AC%E4%BB%B6%E4%B8%B2%E5%8F%A3%E9%87%8D%E5%AE%9A%E4%B9%89"><span class="toc-number">3.2.3.2.</span> <span class="toc-text">硬件串口重定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E8%BD%AF%E4%BB%B6%E4%B8%B2%E5%8F%A3"><span class="toc-number">3.2.3.3.</span> <span class="toc-text">使用软件串口</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E7%BB%84I2C%E6%8E%A5%E5%8F%A3"><span class="toc-number">3.2.4.</span> <span class="toc-text">1组I2C接口</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-2"><span class="toc-number">3.2.4.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B-2"><span class="toc-number">3.2.4.2.</span> <span class="toc-text">实例</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E8%AE%BE%E5%A4%87%E4%BC%A0%E8%BE%93"><span class="toc-number">3.2.4.2.1.</span> <span class="toc-text">主从设备传输</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#Wire%E5%BA%93%E6%96%B9%E6%B3%95"><span class="toc-number">3.2.4.2.1.1.</span> <span class="toc-text">Wire库方法</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E6%94%B6%E5%8F%91"><span class="toc-number">3.2.4.2.1.2.</span> <span class="toc-text">主从收发</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%BA%94%E7%AD%94%E4%BA%A4%E4%BA%92%E9%80%9A%E8%AE%AF"><span class="toc-number">3.2.4.2.1.3.</span> <span class="toc-text">应答交互通讯</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#as5600%E7%BC%96%E7%A0%81%E5%99%A8"><span class="toc-number">3.2.4.2.2.</span> <span class="toc-text">as5600编码器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#oled%E5%B1%8F%E5%B9%95"><span class="toc-number">3.2.4.2.3.</span> <span class="toc-text">oled屏幕</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#16%E4%B8%AAPWM%E9%80%9A%E9%81%93"><span class="toc-number">3.2.5.</span> <span class="toc-text">16个PWM通道</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-3"><span class="toc-number">3.2.5.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B-3"><span class="toc-number">3.2.5.2.</span> <span class="toc-text">实例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E4%B8%AADAC"><span class="toc-number">3.2.6.</span> <span class="toc-text">2个DAC</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-4"><span class="toc-number">3.2.6.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B-4"><span class="toc-number">3.2.6.2.</span> <span class="toc-text">实例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10%E4%B8%AA%E7%94%B5%E5%AE%B9%E6%84%9F%E5%BA%94GPIO"><span class="toc-number">3.2.7.</span> <span class="toc-text">10个电容感应GPIO</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-5"><span class="toc-number">3.2.7.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B-5"><span class="toc-number">3.2.7.2.</span> <span class="toc-text">实例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AD%E6%96%AD"><span class="toc-number">3.2.8.</span> <span class="toc-text">中断</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-6"><span class="toc-number">3.2.8.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B-6"><span class="toc-number">3.2.8.2.</span> <span class="toc-text">实例</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%96%E9%83%A8%E5%BC%95%E8%84%9A%E4%B8%AD%E6%96%AD"><span class="toc-number">3.2.8.2.1.</span> <span class="toc-text">外部引脚中断</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E5%99%A8%E4%B8%AD%E6%96%AD"><span class="toc-number">3.2.8.2.2.</span> <span class="toc-text">定时器中断</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E5%B8%B8%E7%94%A8%E5%86%85%E5%AE%B9"><span class="toc-number">3.2.9.</span> <span class="toc-text">不常用内容</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E4%B8%AAI2S-%E9%AB%98%E9%80%9F%E6%95%B0%E4%BD%8D%E9%9F%B3%E8%AE%AF%E4%BC%A0%E8%BE%93%E6%A0%87%E5%87%86%E5%8D%8F%E8%AE%AE"><span class="toc-number">3.2.9.1.</span> <span class="toc-text">2个I2S:高速数位音讯传输标准协议</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#16%E4%B8%AARTC%E7%9A%84GPIO"><span class="toc-number">3.2.9.2.</span> <span class="toc-text">16个RTC的GPIO</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E7%BD%AE2%E4%B8%AA%E9%9C%8D%E5%B0%94%E4%BC%A0%E6%84%9F%E5%99%A8"><span class="toc-number">3.2.9.3.</span> <span class="toc-text">内置2个霍尔传感器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E8%83%BDEN"><span class="toc-number">3.2.9.4.</span> <span class="toc-text">使能EN</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GPIO%E7%94%B5%E6%B5%81"><span class="toc-number">3.2.9.5.</span> <span class="toc-text">GPIO电流</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BD%AF%E4%BB%B6%E5%BA%94%E7%94%A8"><span class="toc-number">4.</span> <span class="toc-text">软件应用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E6%A0%88"><span class="toc-number">4.1.</span> <span class="toc-text">技术栈</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%89%E9%92%AE%E6%B6%88%E6%8A%96"><span class="toc-number">4.1.1.</span> <span class="toc-text">按钮消抖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%89%E6%B1%A1%E6%9F%93%E5%88%B6%E4%BD%9C%E2%80%93ws2812%E9%A9%B1%E5%8A%A8"><span class="toc-number">4.1.2.</span> <span class="toc-text">光污染制作–ws2812驱动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WIFI%E8%BF%9E%E6%8E%A5%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE"><span class="toc-number">4.1.3.</span> <span class="toc-text">WIFI连接服务器获取数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%93%9D%E7%89%99%E9%94%AE%E7%9B%98"><span class="toc-number">4.1.4.</span> <span class="toc-text">蓝牙键盘</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ESP32-NOW%EF%BC%9A%E4%B8%80%E5%AF%B9%E4%B8%80%E5%8D%95%E5%90%91%E9%80%9A%E4%BF%A1"><span class="toc-number">4.1.5.</span> <span class="toc-text">ESP32 NOW：一对一单向通信</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-7"><span class="toc-number">4.1.5.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%99%90%E5%88%B6"><span class="toc-number">4.1.5.2.</span> <span class="toc-text">限制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B"><span class="toc-number">4.1.5.3.</span> <span class="toc-text">示例</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E7%AB%AF-slave-x2F-sender"><span class="toc-number">4.1.5.3.1.</span> <span class="toc-text">发送端(slave&#x2F;sender)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ESPNOW%E6%8E%A5%E6%94%B6%E7%AB%AF"><span class="toc-number">4.1.5.3.2.</span> <span class="toc-text">ESPNOW接收端</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EEPROM%EF%BC%9A%E6%96%AD%E7%94%B5%E6%95%B0%E6%8D%AE%E4%BF%9D%E5%AD%98"><span class="toc-number">4.1.6.</span> <span class="toc-text">EEPROM：断电数据保存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%8E%E5%8A%9F%E8%80%97"><span class="toc-number">4.1.7.</span> <span class="toc-text">低功耗</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%8E%E5%8A%9F%E8%80%97%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.1.7.1.</span> <span class="toc-text">低功耗模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Modem-sleep"><span class="toc-number">4.1.7.2.</span> <span class="toc-text">Modem-sleep</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Light-sleep"><span class="toc-number">4.1.7.3.</span> <span class="toc-text">Light-sleep</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Deep-sleep"><span class="toc-number">4.1.7.4.</span> <span class="toc-text">Deep-sleep</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E5%94%A4%E9%86%92%EF%BC%9A6uA%E5%B7%A6%E5%8F%B3"><span class="toc-number">4.1.7.4.1.</span> <span class="toc-text">定时唤醒：6uA左右</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Touchpad%E5%94%A4%E9%86%92%EF%BC%9A36uA%E5%B7%A6%E5%8F%B3"><span class="toc-number">4.1.7.4.2.</span> <span class="toc-text">Touchpad唤醒：36uA左右</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#GPIO%E5%94%A4%E9%86%92%EF%BC%9A6uA%E5%B7%A6%E5%8F%B3"><span class="toc-number">4.1.7.4.3.</span> <span class="toc-text">GPIO唤醒：6uA左右</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#web%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">4.1.8.</span> <span class="toc-text">web服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ota%E5%8D%87%E7%BA%A7"><span class="toc-number">4.1.9.</span> <span class="toc-text">ota升级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E6%A0%B8%E6%93%8D%E4%BD%9C"><span class="toc-number">4.1.10.</span> <span class="toc-text">多核操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E6%89%BEESP32%E5%86%85%E6%A0%B8ID"><span class="toc-number">4.1.10.1.</span> <span class="toc-text">查找ESP32内核ID</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8C%E6%A0%B8%E7%BC%96%E7%A8%8B%E6%96%B9%E6%B3%95"><span class="toc-number">4.1.10.2.</span> <span class="toc-text">双核编程方法</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%BB%BB%E5%8A%A1"><span class="toc-number">4.1.10.2.1.</span> <span class="toc-text">创建任务</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89Taskcode%E5%87%BD%E6%95%B0"><span class="toc-number">4.1.10.3.</span> <span class="toc-text">定义Taskcode函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%96%82%E7%8B%97"><span class="toc-number">4.1.10.4.</span> <span class="toc-text">喂狗</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%EF%BC%9Acpu0%E5%88%B7%E6%96%B0tft%E5%B1%8F%E5%B9%95-cpu1%E4%BD%BF%E7%94%A8simplefoc%E6%8E%A7%E5%88%B6%E6%97%A0%E5%88%B7%E7%94%B5%E6%9C%BA"><span class="toc-number">4.1.10.5.</span> <span class="toc-text">示例：cpu0刷新tft屏幕,cpu1使用simplefoc控制无刷电机</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%8D%E6%9D%82%E5%BA%94%E7%94%A8"><span class="toc-number">4.2.</span> <span class="toc-text">复杂应用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E7%BA%BF%E9%85%8D%E7%BD%91"><span class="toc-number">4.2.1.</span> <span class="toc-text">无线配网</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81"><span class="toc-number">4.2.1.1.</span> <span class="toc-text">代码</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%BB%E7%A8%8B%E5%BA%8F"><span class="toc-number">4.2.1.1.1.</span> <span class="toc-text">主程序</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BA%93%E5%A4%B4%E6%96%87%E4%BB%B6"><span class="toc-number">4.2.1.1.2.</span> <span class="toc-text">库头文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BA%93%E6%96%87%E4%BB%B6"><span class="toc-number">4.2.1.1.3.</span> <span class="toc-text">库文件</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%8F%8A%E8%A7%A3%E6%9E%90"><span class="toc-number">4.2.1.2.</span> <span class="toc-text">使用及解析</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%A1%AC%E4%BB%B6%E8%AE%BE%E8%AE%A1-%E5%BC%80%E5%8F%91%E6%9D%BF%E5%88%B6%E4%BD%9C"><span class="toc-number">5.</span> <span class="toc-text">硬件设计(开发板制作)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3"><span class="toc-number">5.1.</span> <span class="toc-text">官方文档</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9%E5%92%8C%E5%90%AF%E5%8A%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">5.2.</span> <span class="toc-text">注意事项和启动配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E5%8E%9F%E7%90%86%E5%9B%BE"><span class="toc-number">5.3.</span> <span class="toc-text">示例原理图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%B9%E8%BF%9B%E7%89%88%E5%8E%9F%E7%90%86%E5%9B%BE"><span class="toc-number">5.4.</span> <span class="toc-text">改进版原理图</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%AF%E8%83%BD%E9%81%87%E5%88%B0%E7%9A%84%E9%94%99%E8%AF%AF"><span class="toc-number">6.</span> <span class="toc-text">可能遇到的错误</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%83%A7%E5%BD%95%E6%8A%A5%E9%94%99-MD5-of-file-does-not-match-data-in-flash"><span class="toc-number">6.1.</span> <span class="toc-text">烧录报错 MD5 of file does not match data in flash</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">7.</span> <span class="toc-text">参考资料</span></a></li></ol></div></div><div class="card-widget ads-wrap"><iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="100%" height=300 src="//music.163.com/outchain/player?type=0&id=9796678610&auto=0&height=430"></iframe></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2025 By Triority</div><div class="footer_custom_text">阿美莉卡ICP备114514号</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'HCrr1LolVdHjaQ03fiyQnqO4-gzGzoHsz',
      appKey: 'SQPN055DPf1nyNHqYj5SBoo2',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: true
    }, null))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>